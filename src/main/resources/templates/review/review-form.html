<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{common/layout/base}">

<head>
  <title>상담 리뷰 작성</title>
  <link rel="stylesheet" th:href="@{/css/review/review-form.css}">
</head>

<div layout:fragment="content">
  <div class="container main">
    <div class="review-form-container">
      <div class="card-custom border-0 p-5">

        <div class="review-header text-center mb-5">
          <h2 class="fw-bold mb-3">🌟 상담 리뷰 작성</h2>
          <p class="text-secondary">
            <span class="fw-bold" style="color: var(--color-status-info);"
                  th:text="${reviewFormDataDto.menteeNickname}">멘티</span>님,
            <span class="fw-bold" th:text="${reviewFormDataDto.mentorNickname}">멘토</span>님과의 멘토링은 어떠셨나요?
          </p>
        </div>

        <form id="reviewForm">
          <input type="hidden" id="matchingId" th:value="${matchingId}">

          <div class="mb-5 text-center">
            <label class="form-label d-block mb-3 fw-bold">이 멘토님을 추천하시겠습니까?</label>
            <div class="row g-3 recommend-selector">
              <div class="col-6">
                <input type="radio" class="btn-check" name="isRecommended" id="recommendYes" value="true" checked>
                <label class="btn btn-outline-custom w-100 py-3 rounded-3" for="recommendYes">
                  <i class="bi bi-hand-thumbs-up-fill d-block fs-3 mb-2 text-success"></i>
                  <span class="fw-medium">추천해요</span>
                </label>
              </div>
              <div class="col-6">
                <input type="radio" class="btn-check" name="isRecommended" id="recommendNo" value="false">
                <label class="btn btn-outline-custom w-100 py-3 rounded-3" for="recommendNo">
                  <i class="bi bi-hand-thumbs-down-fill d-block fs-3 mb-2 text-danger"></i>
                  <span class="fw-medium">아쉬워요</span>
                </label>
              </div>
            </div>
          </div>

          <div class="mb-4">
            <label for="content" class="form-label fw-bold">상세한 후기를 남겨주세요</label>
            <textarea class="modal-textarea" name="content" id="content"
                      placeholder="멘토님의 조언이 어떻게 도움이 되었나요? 따뜻한 후기는 멘토님께 큰 힘이 됩니다. (최대 200자)"
                      maxlength="200" required></textarea>
            <div class="text-end text-small mt-2" id="counterWrapper">
              <span id="charCount">0</span> / 200
            </div>
          </div>

          <div class="d-grid gap-3 mt-5">
            <button type="submit" class="btn btn-primary-custom py-3 fs-5">
              리뷰 등록 완료하기
            </button>
            <a th:href="@{/mentee/dashboard}" class="btn btn-outline-custom py-2">나중에 하기</a>
          </div>
        </form>

      </div>
    </div>
  </div>

  <div class="modal fade" id="confirmModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content border-0 shadow">
        <div class="modal-header border-0 pb-0">
          <h5 class="modal-title fw-bold">리뷰 등록</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body py-4 text-center">
          <p class="text-secondary mb-0 fs-5">작성하신 리뷰를 등록하시겠습니까?</p>
          <p class="text-small text-muted mt-2">등록 후에는 수정할 수 없습니다.</p>
        </div>
        <div class="modal-footer border-0 pt-0 justify-content-center pb-4">
          <button type="button" class="btn btn-light px-4" data-bs-dismiss="modal">취소</button>
          <button type="button" class="btn btn-primary-custom px-4" id="finalSubmitBtn">등록하기</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="successModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content border-0 shadow">
        <div class="modal-body text-center py-5">
          <div class="display-1 text-success mb-4">
            <i class="bi bi-check-circle-fill"></i>
          </div>
          <h4 class="fw-bold mb-3">리뷰가 등록되었습니다!</h4>
          <p class="text-secondary mb-4">소중한 의견을 남겨주셔서 감사합니다.</p>
          <button type="button" class="btn btn-primary-custom px-5 py-2" id="goHomeBtn">
            확인
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<th:block layout:fragment="script">
  <script th:inline="javascript">
    document.addEventListener('DOMContentLoaded', function () {
      const reviewForm = document.getElementById('reviewForm');
      const textarea = document.getElementById('content');
      const countLabel = document.getElementById('charCount');
      const counterWrapper = document.getElementById('counterWrapper');

      const confirmModal = new bootstrap.Modal(document.getElementById('confirmModal'));
      const successModal = new bootstrap.Modal(document.getElementById('successModal'));

      const finalSubmitBtn = document.getElementById('finalSubmitBtn');
      const goHomeBtn = document.getElementById('goHomeBtn');

      // [3단계] 성공 모달 확인 -> 대시보드 이동
      goHomeBtn.addEventListener('click', function() {
        location.href = /*[[@{/mentee/dashboard}]]*/ '/mentee/dashboard';
      });

      // 글자수 세기
      textarea.addEventListener('input', function () {
        const len = this.value.length;
        countLabel.textContent = len;
        if (len >= 200) {
          counterWrapper.style.color = 'var(--color-status-danger)';
          counterWrapper.classList.add('fw-bold');
        } else {
          counterWrapper.style.color = 'var(--color-text-secondary)';
          counterWrapper.classList.remove('fw-bold');
        }
      });

      // [1단계] 폼 제출 시 -> 확인 모달 띄우기
      reviewForm.addEventListener('submit', function (e) {
        e.preventDefault();
        confirmModal.show();
      });

      // [2단계] API 호출 및 성공 처리
      finalSubmitBtn.addEventListener('click', async function() {
        finalSubmitBtn.disabled = true; // 중복 클릭 방지

        const matchingId = document.getElementById('matchingId').value;
        const apiUrl = `/api/reviews/${matchingId}`;

        const data = {
          content: textarea.value,
          isRecommended: reviewForm.querySelector('input[name="isRecommended"]:checked').value === 'true'
        };

        try {
          const response = await fetch(apiUrl, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
          });

          const result = await response.json();

          // [핵심 수정] HTTP 상태 코드가 200번대(OK)면 무조건 성공 처리
          if (response.ok) {
            confirmModal.hide(); // 확인 모달 닫기

            // 자연스러운 전환을 위해 약간의 지연 후 성공 모달 표시
            setTimeout(() => {
              successModal.show();
            }, 200);

          } else {
            // 실패한 경우에만 alert 표시
            alert(result.message || "리뷰 등록 중 오류가 발생했습니다.");
            finalSubmitBtn.disabled = false; // 버튼 다시 활성화
          }
        } catch (error) {
          console.error("에러 발생:", error);
          alert("네트워크 통신 중 오류가 발생했습니다.");
          finalSubmitBtn.disabled = false;
        }
      });
    });
  </script>
</th:block>
</html>
