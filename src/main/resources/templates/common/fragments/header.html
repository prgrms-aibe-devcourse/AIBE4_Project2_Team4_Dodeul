<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<body>

<header th:fragment="header(activeMenu)">
  <div class="container header-inner">
    <a class="brand" th:href="@{/}">DODEUL</a>

    <nav class="nav">
      <a th:href="@{/}" th:classappend="${activeMenu=='home'} ? 'active' : ''">홈</a>
      <a th:href="@{/search/mentors}" th:classappend="${activeMenu=='mentors'} ? 'active' : ''">멘토찾기</a>
      <a th:href="@{/board}" th:classappend="${activeMenu=='board'} ? 'active' : ''">공개 게시판</a>
      <a th:href="@{/mypage}" th:classappend="${activeMenu=='mypage'} ? 'active' : ''">마이페이지</a>
    </nav>

    <div class="header-actions">

      <!-- 비로그인 -->
      <div sec:authorize="isAnonymous()">
        <a class="btn-outline-custom" th:href="@{/auth/login}">로그인</a>
        <a class="btn-primary-custom" th:href="@{/onboarding/role}">회원가입</a>
      </div>

      <!-- 로그인 -->
      <div sec:authorize="isAuthenticated()"
           style="display:flex; align-items:center; gap:12px;">

        <!-- 프로필 이미지 (기본은 숨김) -->
        <img id="headerProfileImg"
             src=""
             alt="profile"
             style="width:32px; height:32px; border-radius:50%; object-fit:cover; display:none;"/>

        <!-- 이니셜 아바타 (기본 표시) -->
        <div id="headerProfileInitial"
             style="width:32px; height:32px; border-radius:50%; background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); color:white; display:flex; align-items:center; justify-content:center; font-weight:600; font-size:14px;">
          U
        </div>

        <!-- role을 JS가 읽도록 숨김 값으로 렌더 -->
        <span id="headerUserRole" sec:authentication="principal.role" style="display:none;">ROLE</span>

        <!-- 유저 이름 -->
        <span id="headerNickname"
              style="font-weight:600;"
              sec:authentication="principal.nickname">
              user
        </span>

        <!-- 로그아웃 -->
        <form th:action="@{/logout}" method="post" style="margin:0;">
          <input type="hidden"
                 th:name="${_csrf.parameterName}"
                 th:value="${_csrf.token}"/>
          <button type="submit" class="btn-outline-custom">
            로그아웃
          </button>
        </form>
      </div>

    </div>
  </div>

  <!-- 헤더 자동 반영 스크립트 -->
  <script sec:authorize="isAuthenticated()">
    (async function () {
      try {
        const nameEl = document.getElementById('headerNickname');
        const imgEl = document.getElementById('headerProfileImg');
        const initialEl = document.getElementById('headerProfileInitial');
        const roleEl = document.getElementById('headerUserRole');

        // 1) 즉시 렌더링된 닉네임 사용 (페이지 로드와 동시에 표시)
        let nickname = (nameEl?.textContent || 'U').trim();
        if (initialEl) {
          initialEl.textContent = nickname.substring(0, 1).toUpperCase();
        }

        // 2) 프로필 이미지는 비동기로 로드
        if (!roleEl || !imgEl || !initialEl) return;
        let role = (roleEl.textContent || '').trim();
        if (role.startsWith('ROLE_')) role = role.replace('ROLE_', '');

        let url = null;
        if (role === 'MENTOR') url = '/api/mypage/mentor/profile';
        else if (role === 'MENTEE') url = '/api/mypage/mentee/profile';
        else return;

        // 프로필 정보 가져오기 (닉네임 + 이미지)
        const res = await fetch(url, {credentials: 'same-origin', headers: {'accept': 'application/json'}});
        const json = await res.json().catch(() => null);

        if (res.ok && json?.data) {
          // 최신 닉네임으로 업데이트
          if (json.data.nickname) {
            nickname = json.data.nickname;
            if (nameEl) nameEl.textContent = nickname;
            if (initialEl) initialEl.textContent = nickname.substring(0, 1).toUpperCase();
          }

          // 프로필 이미지 처리
          const profileUrl = json.data.profileUrl;

          if (profileUrl) {
            // 이미지가 있으면 이미지 표시
            const cacheBusted = profileUrl + (profileUrl.includes('?') ? '&' : '?') + 't=' + Date.now();
            imgEl.src = cacheBusted;
            imgEl.style.display = 'block';
            initialEl.style.display = 'none';
          }
          // 이미지가 없으면 이미 표시된 이니셜 유지
        }

      } catch (e) {
        console.debug('header sync failed', e);
        // 에러 시에도 이미 표시된 이니셜 유지
      }
    })();
  </script>

</header>

</body>
</html>
