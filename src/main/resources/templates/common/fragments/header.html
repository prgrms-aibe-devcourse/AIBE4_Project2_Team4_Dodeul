<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<body>

<header th:fragment="header(activeMenu)">
  <div class="container header-inner">
    <a class="brand" th:href="@{/}">DODEUL</a>

    <nav class="nav">
      <a th:href="@{/}" th:classappend="${activeMenu=='home'} ? 'active' : ''">홈</a>
      <a th:href="@{/search/mentors}" th:classappend="${activeMenu=='mentors'} ? 'active' : ''">멘토찾기</a>
      <a th:href="@{/board}" th:classappend="${activeMenu=='board'} ? 'active' : ''">공개 게시판</a>
      <a th:href="@{/mypage}" th:classappend="${activeMenu=='mypage'} ? 'active' : ''">마이페이지</a>
    </nav>

    <div class="header-actions">

      <!-- 비로그인 -->
      <div sec:authorize="isAnonymous()">
        <a class="btn-outline-custom" th:href="@{/auth/login}">로그인</a>
        <a class="btn-primary-custom" th:href="@{/onboarding/role}">회원가입</a>
      </div>

      <!-- 로그인 -->
      <div sec:authorize="isAuthenticated()"
           style="display:flex; align-items:center; gap:12px;">

        <!-- 프로필 아이콘: JS가 src를 교체할 수 있도록 id 부여 -->
        <img id="headerProfileImg"
             th:src="@{/css/icons/usericon.svg}"
             alt="profile"
             style="width:32px; height:32px; border-radius:50%; background:#f2f2f2; padding:4px; object-fit:cover;"/>

        <!-- role을 JS가 읽도록 숨김 값으로 렌더 -->
        <span id="headerUserRole" sec:authentication="principal.role" style="display:none;">ROLE</span>

        <!-- 유저 이름 -->
        <span id="headerNickname"
              style="font-weight:600;"
              sec:authentication="principal.nickname">
              user
        </span>

        <!-- 로그아웃 -->
        <form th:action="@{/logout}" method="post" style="margin:0;">
          <input type="hidden"
                 th:name="${_csrf.parameterName}"
                 th:value="${_csrf.token}"/>
          <button type="submit" class="btn-outline-custom">
            로그아웃
          </button>
        </form>
      </div>

    </div>
  </div>

  <!-- 헤더 자동 반영 스크립트 -->
  <script sec:authorize="isAuthenticated()">
    (async function () {
      try {
        const nameEl = document.getElementById('headerNickname');
        const imgEl = document.getElementById('headerProfileImg');
        const roleEl = document.getElementById('headerUserRole');

        // 1) 닉네임은 dashboard에서 최신값 가져오기
        const dashRes = await fetch('/api/mypage/dashboard', {
          credentials: 'same-origin',
          headers: {'accept': 'application/json'}
        });
        const dashJson = await dashRes.json().catch(() => null);
        if (dashRes.ok && nameEl && dashJson?.data?.nickname) {
          nameEl.textContent = dashJson.data.nickname;
        }

        // 2) 프로필 이미지 업데이트는 role 기반으로 유지
        if (!roleEl || !imgEl) return;
        let role = (roleEl.textContent || '').trim();
        if (role.startsWith('ROLE_')) role = role.replace('ROLE_', '');

        let url = null;
        if (role === 'MENTOR') url = '/api/mypage/mentor/profile';
        else if (role === 'MENTEE') url = '/api/mypage/mentee/profile';
        else return;

        const res = await fetch(url, {credentials: 'same-origin', headers: {'accept': 'application/json'}});
        const json = await res.json().catch(() => null);
        if (!res.ok) return;

        const profileUrl = json?.data?.profileUrl;
        if (!profileUrl) return;

        const cacheBusted = profileUrl + (profileUrl.includes('?') ? '&' : '?') + 't=' + Date.now();
        imgEl.src = cacheBusted;
        imgEl.style.padding = '0px';
        imgEl.style.background = 'none';
        imgEl.style.objectFit = 'cover';

      } catch (e) {
        console.debug('header sync failed', e);
      }
    })();
  </script>

</header>

</body>
</html>
