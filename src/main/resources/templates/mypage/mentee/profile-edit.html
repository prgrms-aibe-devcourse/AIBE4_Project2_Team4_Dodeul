<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{common/layout/mentee}">

<head>
  <th:block layout:fragment="head">
    <title>DODEUL | 멘티 프로필 수정</title>
    <link rel="stylesheet" href="/css/mypage/dashboard.css">
    <style>
      .profile-avatar {
        position: relative;
        cursor: default;
      }

      .avatar-actions {
        display: flex;
        gap: 10px;
        align-items: center;
        margin-top: 8px;
      }

      .upload-status {
        font-size: 12px;
      }
    </style>
  </th:block>
</head>

<body>

<div layout:fragment="sidebar">
  <div th:replace="~{common/fragments/sidebar :: sidebar('profile')}"></div>
</div>

<div layout:fragment="page">

  <div class="dashboard-header">
    <h2 class="fw-bold" style="margin-bottom:8px;">프로필 수정</h2>
    <p class="text-small" style="margin-bottom:16px;">멘티 프로필 정보를 수정할 수 있습니다.</p>
  </div>

  <!-- 상단 프로필 카드 -->
  <section class="card-custom" style="margin-bottom:16px;">
    <div class="dashboard-profile">
      <div class="dashboard-avatar-lg profile-avatar" id="profileAvatar"></div>

      <div style="flex:1;">
        <div class="fw-bold" id="menteeName" style="margin-bottom:4px;">-</div>
        <div class="text-small" id="menteeMeta">희망 직무 / 관심 상담 분야</div>

        <!-- 이미지 업로드 UI -->
        <div class="avatar-actions">
          <input
            type="file"
            id="profileImageInput"
            accept="image/png,image/jpeg"
            style="display:none"
          />
          <button id="changeImageBtn" class="btn-outline-custom" type="button">이미지 변경</button>
          <span id="uploadStatus" class="upload-status text-small"></span>
        </div>
      </div>

      <a class="btn-outline-custom" href="/mentee/profile">조회 화면</a>
    </div>
  </section>

  <!-- 편집 폼 -->
  <form class="card-custom" style="margin-bottom:16px;" onsubmit="return false;">
    <div class="fw-bold" style="margin-bottom:10px;">희망 직무</div>
    <input id="desiredJobInput" class="form-control-custom" type="text"
           placeholder="예: 백엔드 개발자">

    <div class="fw-bold" style="margin:16px 0 10px;">자기소개</div>
    <textarea id="bioInput" class="form-control-custom" rows="5"
              placeholder="자기소개를 입력해 주세요."></textarea>

    <div class="fw-bold" style="margin:16px 0 10px;">기술 스택</div>
    <input id="skillsInput" class="form-control-custom" type="text"
           placeholder="예: Java, Spring">

    <div class="fw-bold" style="margin:16px 0 10px;">상담 희망 분야</div>
    <input id="interestsInput" class="form-control-custom" type="text"
           placeholder="예: RESUME, CAREER">

    <p class="text-small" style="margin-top:12px;">
      ※ 기술스택/상담분야는 콤마(,)로 구분해서 입력해주세요.
    </p>

    <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:16px;">
      <a class="btn-outline-custom" href="/mentee/profile">취소</a>
      <button id="saveBtn" class="btn-primary-custom" type="button">저장</button>
    </div>
  </form>

  <p id="profileError" style="color:#d33; margin-top:12px;"></p>

</div>

<th:block layout:fragment="script">
  <script>
    async function apiRequest(url, options = {}) {
      const res = await fetch(url, {
        credentials: 'same-origin',
        headers: {
          'accept': 'application/json',
          ...(options.headers || {})
        },
        ...options
      });

      const json = await res.json().catch(() => null);
      const code = json?.code ?? res.status;
      const message = json?.message ?? `요청 실패(${res.status})`;

      if (code === 401) {
        showCommonModal('로그인이 필요합니다.');
        location.href = '/auth/login';
        throw new Error('UNAUTHORIZED');
      }
      if (code === 403) {
        showCommonModal(message || '접근 권한이 없습니다.');
        location.href = '/';
        throw new Error('FORBIDDEN');
      }

      if (!res.ok || (typeof code === 'number' && code >= 400)) {
        const err = new Error(message);
        err.code = code;
        err.payload = json;
        throw err;
      }
      return json;
    }

    function toListByComma(input) {
      return String(input ?? '')
        .split(',')
        .map(s => s.trim())
        .filter(Boolean);
    }

    function setAvatar(url) {
      const avatar = document.getElementById('profileAvatar');
      if (!avatar) return;

      if (url) {
        avatar.style.backgroundImage = `url(${url})`;
        avatar.style.backgroundSize = 'cover';
        avatar.style.backgroundPosition = 'center';
      } else {
        avatar.style.backgroundImage = 'none';
      }
    }

    // 이미지 업로드
    document.getElementById('changeImageBtn').addEventListener('click', () => {
      document.getElementById('profileImageInput').click();
    });

    document.getElementById('profileImageInput').addEventListener('change', async (e) => {
      const status = document.getElementById('uploadStatus');
      status.textContent = '';

      const file = e.target.files && e.target.files[0];
      if (!file) return;

      try {
        status.textContent = '업로드 중...';

        const form = new FormData();
        form.append('file', file);

        const res = await fetch('/api/mypage/mentee/profile-image', {
          method: 'POST',
          body: form,
          credentials: 'same-origin'
        });

        const json = await res.json().catch(() => null);
        if (!res.ok) {
          status.textContent = json?.message || '이미지 업로드 실패';
          return;
        }

        const url = json?.data;
        setAvatar(url);
        status.textContent = '업로드 완료';

      } catch (err) {
        console.error(err);
        status.textContent = '서버 오류';
      } finally {
        // 같은 파일 재선택 가능하도록 초기화
        e.target.value = '';
      }
    });

    // 초기값 로딩
    (async function () {
      const err = document.getElementById('profileError');
      try {
        const res = await fetch('/api/mypage/mentee/profile', {credentials: 'same-origin'});
        const json = await res.json().catch(() => null);
        if (!res.ok) {
          err.textContent = json?.message || '프로필 정보를 불러오지 못했습니다.';
          return;
        }

        const data = json?.data || {};
        document.getElementById('menteeName').textContent = data.nickname ? `${data.nickname} 멘티` : '멘티';

        const desiredJob = data.job ?? '-';
        const interests = (data.consultingTags && data.consultingTags.length)
          ? data.consultingTags.join(', ')
          : '-';
        document.getElementById('menteeMeta').textContent = `희망 직무: ${desiredJob} · 관심 상담 분야: ${interests}`;

        setAvatar(data.profileUrl);

        document.getElementById('desiredJobInput').value = data.job ?? '';
        document.getElementById('bioInput').value = data.intro ?? '';
        document.getElementById('skillsInput').value =
          (data.skillTags && data.skillTags.length) ? data.skillTags.join(', ') : '';
        document.getElementById('interestsInput').value =
          (data.consultingTags && data.consultingTags.length) ? data.consultingTags.join(', ') : '';

      } catch (e) {
        console.error(e);
        err.textContent = '서버와 통신할 수 없습니다.';
      }
    })();

    // 저장
    document.getElementById('saveBtn').addEventListener('click', async () => {
      const err = document.getElementById('profileError');
      err.textContent = '';

      const payload = {
        job: document.getElementById('desiredJobInput').value.trim(),
        intro: document.getElementById('bioInput').value.trim(),
        skillTags: toListByComma(document.getElementById('skillsInput').value),
        consultingTags: toListByComma(document.getElementById('interestsInput').value),
      };

      try {
        await apiRequest('/api/mypage/mentee/profile', {
          method: 'PATCH',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(payload)
        });

        showCommonModal('저장되었습니다.');
        setTimeout(() => location.href = '/mentee/profile', 300);
      } catch (e) {
        console.error(e);
        err.textContent = e?.message ?? '저장 중 오류가 발생했습니다.';
      }
    });
  </script>
</th:block>

</body>
</html>
