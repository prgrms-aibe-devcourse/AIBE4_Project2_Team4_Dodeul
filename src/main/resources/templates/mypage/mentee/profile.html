<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{common/layout/mentee}">

<head>
  <th:block layout:fragment="head">
    <title>DODEUL | 멘티 프로필</title>
    <link rel="stylesheet" href="/css/mypage/dashboard.css">
    <style>
      #profileAvatar {
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
      }

      /* 이니셜 아바타 스타일 */
      #profileAvatar.avatar-initial {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
        color: white !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        font-weight: 600 !important;
        font-size: 32px !important;
        line-height: 1 !important;
      }
    </style>
  </th:block>
</head>

<body>

<div layout:fragment="sidebar">
  <div th:replace="~{common/fragments/sidebar :: sidebar('profile')}"></div>
</div>

<div layout:fragment="page">
  <div class="dashboard-header">
    <h2 class="fw-bold" style="margin-bottom:8px;">프로필</h2>
    <p class="text-small" style="margin-bottom:16px;">멘티 프로필 정보를 확인할 수 있습니다.</p>
  </div>

  <section class="card-custom" style="margin-bottom:16px;">
    <div class="dashboard-profile">
      <div class="dashboard-avatar-lg" id="profileAvatar"></div>

      <div style="flex:1;">
        <div class="fw-bold" id="menteeName" style="margin-bottom:4px;">-</div>
        <div class="text-small" id="menteeMeta">희망 직무 / 관심 상담 분야</div>
      </div>
    </div>
  </section>

  <section class="card-custom" style="margin-bottom:16px;">
    <div class="fw-bold" style="margin-bottom:10px;">희망 직무</div>
    <div id="desiredJob" class="text-small">불러오는 중…</div>
  </section>

  <section class="card-custom" style="margin-bottom:16px;">
    <div class="fw-bold" style="margin-bottom:10px;">자기소개</div>
    <div id="menteeBio" class="text-small" style="white-space:pre-line;">불러오는 중…</div>
  </section>

  <section class="card-custom" style="margin-bottom:16px;">
    <div class="fw-bold" style="margin-bottom:10px;">기술 스택</div>
    <div id="menteeSkills"><span class="text-small">불러오는 중…</span></div>
  </section>

  <section class="card-custom" style="margin-bottom:16px;">
    <div class="fw-bold" style="margin-bottom:10px;">상담 희망 분야</div>
    <div id="menteeConsultings"><span class="text-small">불러오는 중…</span></div>
  </section>

  <div style="display:flex; justify-content:flex-end; margin-top:16px;">
    <a class="btn-outline-custom" href="/mentee/profile/edit">수정</a>
  </div>

  <p id="profileError" style="color:#d33; margin-top:12px;"></p>
</div>

<th:block layout:fragment="script">
  <script>
    function escapeHtml(s) {
      return String(s ?? '')
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", "&#039;");
    }

    function renderTags(root, arr) {
      if (!arr || arr.length === 0) {
        root.innerHTML = `<span class="text-small">-</span>`;
        return;
      }
      root.innerHTML = arr.map(t => `<span class="tag tag--read-only">${escapeHtml(t)}</span>`).join('');
    }

    function setAvatar(url, nickname) {
      const el = document.getElementById('profileAvatar');
      if (!el) return;

      if (url) {
        // 이미지가 있는 경우
        const cacheBusted = url + (url.includes('?') ? '&' : '?') + 't=' + Date.now();
        el.style.backgroundImage = `url(${cacheBusted})`;
        el.classList.remove('avatar-initial');
        el.textContent = '';
      } else {
        // 이미지가 없는 경우 - 이니셜 표시
        el.style.backgroundImage = 'none';
        el.classList.add('avatar-initial');
        el.textContent = nickname ? nickname.substring(0, 1).toUpperCase() : 'U';
      }
    }

    (async function () {
      const err = document.getElementById('profileError');

      try {
        const res = await fetch('/api/mypage/mentee/profile', {credentials: 'same-origin'});
        const json = await res.json().catch(() => null);
        if (!res.ok) {
          err.textContent = json?.message || '프로필 정보를 불러오지 못했습니다.';
          return;
        }

        const data = json?.data || {};
        const nickname = data.nickname || '멘티';
        document.getElementById('menteeName').textContent = data.nickname ? `${data.nickname} 멘티` : '멘티';

        const desiredJob = data.job ?? '-';
        const interests = (data.consultingTags && data.consultingTags.length)
          ? data.consultingTags.join(', ')
          : '-';

        document.getElementById('menteeMeta').textContent = `희망 직무: ${desiredJob} · 관심 상담 분야: ${interests}`;
        document.getElementById('desiredJob').textContent = desiredJob;

        document.getElementById('menteeBio').textContent =
          data.intro ?? '자기소개가 아직 등록되지 않았습니다.';

        renderTags(document.getElementById('menteeSkills'), data.skillTags ?? []);
        renderTags(document.getElementById('menteeConsultings'), data.consultingTags ?? []);

        setAvatar(data.profileUrl, nickname);

      } catch (e) {
        err.textContent = '서버와 통신할 수 없습니다.';
        console.error(e);
      }
    })();
  </script>
</th:block>

</body>
</html>
