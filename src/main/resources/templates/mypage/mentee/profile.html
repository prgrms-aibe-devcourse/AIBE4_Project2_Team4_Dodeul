<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{common/layout/mentee}">

<head>
  <th:block layout:fragment="head">
    <title>DODEUL | 멘티 프로필</title>
    <link rel="stylesheet" href="/css/mypage/dashboard.css">
  </th:block>
</head>

<body>
<div layout:fragment="page">
  <div class="dashboard-header">
    <h2 class="fw-bold" style="margin-bottom:8px;">프로필</h2>
    <p class="text-small" style="margin-bottom:16px;">멘티 프로필 정보를 확인할 수 있습니다.</p>
  </div>

  <!-- 상단 프로필 카드 -->
  <section class="card-custom" style="margin-bottom:16px;">
    <div class="dashboard-profile">
      <div class="dashboard-avatar-lg"></div>
      <div style="flex:1;">
        <div class="fw-bold" id="menteeName" style="margin-bottom:4px;">-</div>
        <div class="text-small" id="menteeMeta">희망 직무 / 관심 상담 분야</div>
      </div>
    </div>
  </section>

  <!-- 희망 직무 -->
  <section class="card-custom" style="margin-bottom:16px;">
    <div class="fw-bold" style="margin-bottom:10px;">희망 직무</div>
    <div id="desiredJob" class="text-small">불러오는 중…</div>
  </section>

  <!-- 자기소개 -->
  <section class="card-custom" style="margin-bottom:16px;">
    <div class="fw-bold" style="margin-bottom:10px;">자기소개</div>
    <div id="menteeBio" class="text-small" style="white-space:pre-line;">
      불러오는 중…
    </div>
  </section>

  <!-- 기술 스택 -->
  <section class="card-custom" style="margin-bottom:16px;">
    <div class="fw-bold" style="margin-bottom:10px;">기술 스택</div>
    <div id="menteeSkills">
      <span class="text-small">불러오는 중…</span>
    </div>
  </section>

  <!-- 상담 희망 분야 -->
  <section class="card-custom" style="margin-bottom:16px;">
    <div class="fw-bold" style="margin-bottom:10px;">상담 희망 분야</div>
    <div id="menteeConsultings">
      <span class="text-small">불러오는 중…</span>
    </div>
  </section>

  <div style="display:flex; justify-content:flex-end; margin-top:16px;">
    <a class="btn-outline-custom" href="/mentee/profile/edit">수정</a>
  </div>

  <p id="profileError" style="color:#d33; margin-top:12px;"></p>
</div>

<th:block layout:fragment="script">
  <script>
    function escapeHtml(s) {
      return String(s ?? '')
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", "&#039;");
    }

    function renderTags(root, arr) {
      if (!arr || arr.length === 0) {
        root.innerHTML = `<span class="text-small">-</span>`;
        return;
      }
      root.innerHTML = arr.map(t => `<span class="tag tag--read-only">${escapeHtml(t)}</span>`).join('');
    }

    (async function () {
      const err = document.getElementById('profileError');

      try {
        const res = await fetch('/api/mypage/dashboard', {credentials: 'same-origin'});
        const json = await res.json();
        if (!res.ok) {
          err.textContent = json?.message || '프로필 정보를 불러오지 못했습니다.';
          return;
        }

        const data = json.data || {};
        document.getElementById('menteeName').textContent = data.nickname ? `${data.nickname} 멘티` : '멘티';

        const desiredJob = data.desiredJobName ?? '-';
        const interests = (data.interestConsultings && data.interestConsultings.length)
          ? data.interestConsultings.join(', ')
          : '-';

        document.getElementById('menteeMeta').textContent = `희망 직무: ${desiredJob} · 관심 상담 분야: ${interests}`;
        document.getElementById('desiredJob').textContent = desiredJob;

        document.getElementById('menteeBio').textContent =
          data.bio ?? '자기소개가 아직 등록되지 않았습니다.';

        renderTags(
          document.getElementById('menteeSkills'),
          data.skillTags ?? ['Java', 'Spring'] // 임시
        );

        renderTags(
          document.getElementById('menteeConsultings'),
          data.interestConsultings ?? ['이력서', '면접'] // 임시
        );

      } catch (e) {
        err.textContent = '서버와 통신할 수 없습니다.';
        console.error(e);
      }
    })();
  </script>
</th:block>

</body>
</html>
