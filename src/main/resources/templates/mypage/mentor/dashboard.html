<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{common/layout/mentor}">

<head>
  <th:block layout:fragment="head">
    <title>DODEUL | 멘토 대시보드</title>
    <link rel="stylesheet" href="/css/mypage/dashboard.css">
    <style>
      #profileAvatar {
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
      }
    </style>
  </th:block>
</head>

<body>

<div layout:fragment="sidebar">
  <div th:replace="~{common/fragments/sidebar :: sidebar('dashboard')}"></div>
</div>

<div layout:fragment="page">
  <div class="dashboard-header">
    <h2 class="fw-bold" style="margin-bottom:8px;">대시보드</h2>
    <p id="dashboardSubtitle" class="text-small" style="margin-bottom:16px;">
      멘토님의 상담 및 일정 현황을 불러오는 중입니다.
    </p>
  </div>

  <!-- 상단 프로필 카드 -->
  <section class="card-custom" style="margin-bottom:16px;">
    <div class="dashboard-profile">
      <div class="dashboard-avatar-lg" id="profileAvatar"></div>
      <div style="flex:1;">
        <div class="fw-bold" id="mentorName" style="margin-bottom:4px;">-</div>
        <div class="text-small" id="mentorDesc">내 프로필 정보를 불러오는 중…</div>

        <!-- 상담 상태 + 토글 버튼 -->
        <div style="margin-top:10px; display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
          <span class="text-small">
            상담 상태: <strong id="consultationStatusText">-</strong>
          </span>

          <button type="button"
                  class="btn-outline-custom"
                  id="toggleConsultationBtn"
                  style="padding:8px 10px; font-size:12px;">
            상태 변경
          </button>

          <span class="text-small" id="consultationStatusHint" style="opacity:0.8;"></span>
        </div>
      </div>

      <a class="btn-outline-custom" href="/mentor/profile">프로필 보기</a>
    </div>
  </section>

  <!-- 상담 현황 요약 -->
  <section style="margin-bottom:16px;">
    <div class="fw-bold" style="margin-bottom:10px;">상담 현황 요약</div>

    <div class="dashboard-summary-grid">
      <div class="card-custom" style="margin:0; position:relative;">
        <div class="text-small">받은 상담 신청</div>
        <div class="dashboard-summary-value">
          <span id="sumScheduled">-</span><span class="dashboard-unit">건</span>
        </div>
        <span class="status-badge status-pending">대기중</span>
        <a class="text-small" style="position:absolute; right:16px; bottom:16px;" href="/mentor/sessions">상담 내역 보기 →</a>
      </div>

      <div class="card-custom" style="margin:0; position:relative;">
        <div class="text-small">진행중 상담</div>
        <div class="dashboard-summary-value">
          <span id="sumOngoing">-</span><span class="dashboard-unit">건</span>
        </div>
        <span class="status-badge status-approved">승인됨</span>
        <a class="text-small" style="position:absolute; right:16px; bottom:16px;" href="/mentor/sessions">상담 내역 보기 →</a>
      </div>

      <div class="card-custom" style="margin:0; position:relative;">
        <div class="text-small">완료된 상담</div>
        <div class="dashboard-summary-value">
          <span id="sumCompleted">-</span><span class="dashboard-unit">건</span>
        </div>
        <span class="status-badge status-completed">완료</span>
        <a class="text-small" style="position:absolute; right:16px; bottom:16px;" href="/mentor/sessions">상담 내역 보기 →</a>
      </div>
    </div>
  </section>

  <!-- 진행중인 상담 -->
  <section style="margin-bottom:16px;">
    <div class="fw-bold" style="margin-bottom:10px;">진행중인 상담</div>
    <div class="card-custom dashboard-list" id="ongoingList" style="margin:0;">
      <div class="dashboard-row">
        <div class="text-small">불러오는 중…</div>
      </div>
    </div>
  </section>

  <!-- 최근 상담 내역 -->
  <section style="margin-bottom:16px;">
    <div class="fw-bold" style="margin-bottom:10px;">최근 상담 내역</div>
    <div class="card-custom dashboard-list" id="recentList" style="margin:0;">
      <div class="dashboard-row">
        <div class="text-small">불러오는 중…</div>
      </div>
    </div>
  </section>

  <!-- 최근 스크랩 -->
  <section style="margin-bottom:16px;">
    <div class="fw-bold" style="margin-bottom:10px;">최근 스크랩 글</div>
    <div class="card-custom dashboard-list" id="scrapBox" style="margin:0;">
      <div class="dashboard-row">
        <div class="text-small">스크랩 글을 불러오는 중…</div>
      </div>
    </div>
  </section>

  <p id="dashboardError" style="color:#d33; margin-top:12px;"></p>
</div>

<th:block layout:fragment="script">
  <script>
    async function apiRequest(url, options = {}) {
      const res = await fetch(url, {
        credentials: 'same-origin',
        headers: {'accept': 'application/json', ...(options.headers || {})},
        ...options
      });

      const json = await res.json().catch(() => null);
      const code = json?.code ?? res.status;
      const message = json?.message ?? `요청 실패(${res.status})`;

      if (code === 401) {
        alert('로그인이 필요합니다.');
        location.href = '/';
        throw new Error('UNAUTHORIZED');
      }
      if (code === 403) {
        alert(message || '접근 권한이 없습니다.');
        location.href = '/';
        throw new Error('FORBIDDEN');
      }
      if (!res.ok || (typeof code === 'number' && code >= 400)) {
        const err = new Error(message);
        err.code = code;
        err.payload = json;
        throw err;
      }
      return json;
    }

    function escapeHtml(s) {
      return String(s ?? '')
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", "&#039;");
    }

    function setAvatar(url) {
      const el = document.getElementById('profileAvatar');
      if (!el) return;

      if (url) {
        const cacheBusted = url + (url.includes('?') ? '&' : '?') + 't=' + Date.now();
        el.style.backgroundImage = `url(${cacheBusted})`;
      } else {
        el.style.backgroundImage = 'none';
      }
    }

    function formatDateTime(v) {
      if (!v) return '-';
      const s = String(v).replace('T', ' ');
      return s.slice(0, 16);
    }

    function renderRows(rootEl, items, emptyText, rightButtonLabel, rightButtonHrefBuilder) {
      if (!items || items.length === 0) {
        rootEl.innerHTML =
          `<div class="dashboard-row"><div class="text-small">${escapeHtml(emptyText)}</div></div>`;
        return;
      }

      rootEl.innerHTML = items.map(it => {
        const title = escapeHtml(it.title ?? '제목 없음');
        const name = escapeHtml(it.counterpartName ?? '-');
        const time = escapeHtml(formatDateTime(it.startAt));
        const href = rightButtonHrefBuilder ? rightButtonHrefBuilder(it) : null;

        return `
          <div class="dashboard-row">
            <div>
              <div class="dashboard-row-title">${title}</div>
              <div class="dashboard-row-sub">${name} · ${time}</div>
            </div>
            <div class="dashboard-row-right">
              ${href ? `<a class="btn-outline-custom" style="padding:8px 10px; font-size:12px;" href="${escapeHtml(href)}">${escapeHtml(rightButtonLabel)}</a>` : ''}
            </div>
          </div>
        `;
      }).join('');
    }

    (async function () {
      const err = document.getElementById('dashboardError');

      try {
        // 1) 대시보드 데이터
        const dashJson = await apiRequest('/api/mypage/dashboard');
        const dash = dashJson.data || {};

        document.getElementById('dashboardSubtitle').textContent = '멘토님의 상담 현황을 확인해보세요.';

        document.getElementById('sumScheduled').textContent = dash.summary?.scheduled ?? '-';
        document.getElementById('sumOngoing').textContent = dash.summary?.ongoing ?? '-';
        document.getElementById('sumCompleted').textContent = dash.summary?.completed ?? '-';

        const upcoming = dash.upcomingSessions || [];
        renderRows(
          document.getElementById('ongoingList'),
          upcoming.slice(0, 2),
          '진행중인 상담이 없습니다.',
          '상담 내역',
          () => `/mentor/sessions`
        );

        const completedRecentSessions = dash.completedRecentSessions || [];
        renderRows(
          document.getElementById('recentList'),
          completedRecentSessions,
          '최근 완료된 상담 내역이 없습니다.',
          '상담 내역 조회',
          () => `/mentor/sessions`
        );

        const scrapEl = document.getElementById('scrapBox');
        const mockScrap = {title: '멘토링 질문 템플릿 공유합니다', href: '/board/posts'};
        scrapEl.innerHTML = `
          <div class="dashboard-row">
            <div>
              <div class="dashboard-row-title">${escapeHtml(mockScrap.title)}</div>
              <div class="dashboard-row-sub">스크랩한 게시글 1건</div>
            </div>
            <div class="dashboard-row-right">
              <a class="btn-outline-custom" style="padding:8px 10px; font-size:12px;" href="${escapeHtml(mockScrap.href)}">게시글 보기</a>
            </div>
          </div>
        `;

        // 2) 프로필 데이터 (+ 상담 상태 토글)
        const profileRes = await fetch('/api/mypage/mentor/profile', {credentials: 'same-origin'});
        const profileJson = await profileRes.json().catch(() => null);

        if (profileRes.ok) {
          const p = profileJson?.data || {};
          document.getElementById('mentorName').textContent = p.nickname ? `${p.nickname} 멘토` : '멘토';

          const job = p.job ?? '-';
          const fields = (p.consultingTags && p.consultingTags.length) ? p.consultingTags.join(', ') : '-';
          document.getElementById('mentorDesc').textContent = `${job} / ${fields}`;

          setAvatar(p.profileUrl);

          // 상담 상태 렌더링 + 토글 버튼 연결
          const enabled = !!p.consultationEnabled;

          const statusTextEl = document.getElementById('consultationStatusText');
          const hintEl = document.getElementById('consultationStatusHint');
          const btn = document.getElementById('toggleConsultationBtn');

          if (statusTextEl) statusTextEl.textContent = enabled ? '상담 가능' : '상담 불가';

          if (hintEl) {
            hintEl.textContent = enabled
              ? '현재 상담 신청을 받고 있습니다.'
              : '현재 상담 신청을 받지 않습니다.';
          }

          if (btn) {
            btn.textContent = enabled ? '상담 안받기' : '상담 받기';
            btn.onclick = async () => {
              const next = !enabled;
              const label = next ? '상담을 받도록 전환' : '상담을 받지 않도록 전환';

              if (!confirm(`${label}할까요?`)) return;

              try {
                btn.disabled = true;

                await apiRequest('/api/mentor/profile/consultation-enabled', {
                  method: 'PATCH',
                  headers: {
                    'content-type': 'application/json',
                    'accept': 'application/json'
                  },
                  body: JSON.stringify({enabled: next})
                });

                location.reload();
              } catch (e) {
                console.error(e);
                alert(e?.message ?? '상담 상태 변경에 실패했습니다.');
              } finally {
                btn.disabled = false;
              }
            };
          }
        }
      } catch (e) {
        console.error(e);
        err.textContent = e?.message ?? '서버와 통신할 수 없습니다.';
      }
    })();
  </script>
</th:block>

</body>
</html>
