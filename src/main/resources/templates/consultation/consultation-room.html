<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{common/layout/base}">

<head>
  <title>ìƒë‹´ ì±„íŒ…ë°©</title>
  <link rel="stylesheet" th:href="@{/css/consultation/consultation-room.css}">
</head>

<div layout:fragment="content">

  <th:block th:with="opponent=${consultationRoomDto.participants.get(0).memberId == consultationRoomDto.currentMemberId ? consultationRoomDto.participants.get(1) : consultationRoomDto.participants.get(0)}">

    <div class="mb-4">
      <h2 class="fw-bold">ğŸ’¬ ìƒë‹´ ì±„íŒ…ë°©</h2>
      <p class="text-small">
        <span class="fw-bold" th:text="${opponent.nickname}">ìƒëŒ€ë°©</span>ë‹˜ê³¼ì˜ ëŒ€í™”ì…ë‹ˆë‹¤.
      </p> </div>

    <div class="row g-4">
      <div class="col-lg-8">
        <div class="chat-container">

          <div class="chat-header">
            <div class="d-flex align-items-center">
              <div class="me-3">
                <img th:if="${opponent.profileUrl != null}"
                     th:src="${opponent.profileUrl}" class="rounded-circle"
                     style="width: 40px; height: 40px; border: 1px solid var(--color-border); object-fit: cover;">
                <div th:unless="${opponent.profileUrl != null}"
                     class="bg-light rounded-circle d-flex align-items-center justify-content-center border"
                     style="width: 40px; height: 40px;">
                  <i class="bi bi-person-fill text-secondary fs-5"></i>
                </div>
              </div>
              <div>
                <div class="fw-bold" th:text="${opponent.nickname}">ë‹‰ë„¤ì„</div>
                <div class="text-small text-secondary">
                  <span class="badge bg-light text-dark border rounded-pill">ì°¸ì—¬ì</span>
                </div>
              </div>
            </div>
            <div>
              <button class="btn btn-sm btn-outline-custom">
                <i class="bi bi-box-arrow-right me-1"></i>ë‚˜ê°€ê¸°
              </button>
            </div>
          </div>

          <div class="chat-messages" id="chatMessages">
            <th:block th:each="message : ${consultationRoomDto.messageDtoList}">

              <div th:if="${message.type.name() == 'SYSTEM'}" class="text-center my-3">
                                <span class="badge bg-light text-secondary fw-normal border px-3 py-2 rounded-pill"
                                      th:text="${message.content}">ì‹œìŠ¤í…œ</span>
              </div>

              <div th:unless="${message.type.name() == 'SYSTEM'}"
                   class="d-flex flex-column mb-2"
                   th:classappend="${message.senderId == consultationRoomDto.currentMemberId} ? 'align-items-end' : 'align-items-start'">

                                <span th:if="${message.senderId != consultationRoomDto.currentMemberId}"
                                      th:text="${message.senderNickname}"
                                      class="text-secondary ms-1 mb-1"
                                      style="font-size: 0.75rem;">ë‹‰ë„¤ì„</span>

                <div class="message"
                     th:classappend="${message.senderId == consultationRoomDto.currentMemberId} ? 'sent' : 'received'">

                  <div th:if="${message.type.name() == 'IMAGE'}">
                    <img th:src="${message.content}" alt="ì´ë¯¸ì§€"
                         style="max-width: 100%; border-radius: 8px; cursor: pointer;"
                         onclick="window.open(this.src)">
                  </div>
                  <span th:unless="${message.type.name() == 'IMAGE'}"
                        th:text="${message.content}">ë‚´ìš©</span>
                </div>
              </div>

            </th:block>
          </div>

          <div class="chat-input-area">
            <button class="btn btn-outline-custom px-2" title="íŒŒì¼ ì²¨ë¶€">
              <i class="bi bi-paperclip fs-5"></i>
            </button>
            <textarea class="chat-input" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." rows="1"></textarea>
            <button id="send-btn" class="btn btn-primary-custom"
                    style="height: 48px; padding-left: 1.5rem; padding-right: 1.5rem;">ì „ì†¡
            </button>
          </div>
        </div>
      </div>

      <div class="col-lg-4">
        <div class="side-panel-card">
          <div class="side-panel-title">
            <span>ğŸ“„ ìƒë‹´ ì‹ ì²­ì„œ</span>
          </div>
          <dl class="application-summary mb-0">
            <dt>ì‹ ì²­ ì œëª©</dt>
            <dd th:text="${consultationRoomDto.consultingApplicationDto.title}">ì œëª©</dd>

            <dt>í¬ë§ ì§ë¬´</dt>
            <dd><span class="tag tag--read-only mb-0 py-1 px-2" style="font-size: 0.8rem;"
                      th:text="${consultationRoomDto.consultingApplicationDto.consultingTag}">íƒœê·¸</span></dd>

            <dt>ìƒë‹´ ë‚´ìš© ìš”ì•½</dt>
            <dd class="text-secondary" style="font-size: 0.9rem; line-height: 1.4;"
                th:text="${consultationRoomDto.consultingApplicationDto.content}">
              ë‚´ìš©
            </dd>
          </dl>
        </div>

        <div class="side-panel-card">
          <div class="side-panel-title">
            <span>ğŸ—‚ ì£¼ê³ ë°›ì€ íŒŒì¼</span>
          </div>
          <div class="file-list">
            <a th:if="${consultationRoomDto.consultingApplicationDto.fileUrl != null}"
               th:href="${consultationRoomDto.consultingApplicationDto.fileUrl}"
               class="file-item text-decoration-none" target="_blank">
              <div class="file-icon"><i class="bi bi-file-earmark-text"></i></div>
              <div class="file-info">
                <div class="file-name text-dark">ì‹ ì²­ì„œ ì²¨ë¶€íŒŒì¼</div>
                <div class="file-size">ë‹¤ìš´ë¡œë“œ</div>
              </div>
              <div class="ms-2 text-secondary">
                <i class="bi bi-download"></i>
              </div>
            </a>
            <div th:unless="${consultationRoomDto.consultingApplicationDto.fileUrl != null}"
                 class="text-center text-secondary py-3">
              <small>ì£¼ê³ ë°›ì€ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.</small>
            </div>
          </div>
        </div>
      </div>
    </div>
  </th:block>
</div>

<th:block layout:fragment="script">
  <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>

  <script th:inline="javascript">
    document.addEventListener('DOMContentLoaded', function () {
      const chatMessages = document.getElementById('chatMessages');
      const textarea = document.querySelector('.chat-input');
      const sendBtn = document.getElementById('send-btn');

      // [ìˆ˜ì •] DTO ì•ˆì— ìˆëŠ” ê°’ìœ¼ë¡œ ë³€ê²½
      const roomId = [[${consultationRoomDto.consultationRoomId}]];
      const currentMemberId = [[${consultationRoomDto.currentMemberId}]];

      if (chatMessages) chatMessages.scrollTop = chatMessages.scrollHeight;

      // WebSocket ì—°ê²°
      const socket = new SockJS('/ws');
      const stompClient = Stomp.over(socket);

      stompClient.connect({}, function () {
        stompClient.subscribe('/topic/room/' + roomId, function (response) {
          appendMessage(JSON.parse(response.body));
        });
      });

      // ë©”ì‹œì§€ ì „ì†¡
      function sendMessage() {
        const content = textarea.value.trim();
        if (content && stompClient.connected) {
          stompClient.send("/app/chat/send", {}, JSON.stringify({
            'roomId': roomId,
            'senderId': currentMemberId,
            'content': content
          }));
          textarea.value = '';
          textarea.style.height = '48px';
        }
      }

      // ë©”ì‹œì§€ í™”ë©´ ì¶”ê°€
      function appendMessage(msg) {
        const isMine = (msg.senderId == currentMemberId);

        // Flex container
        const wrapper = document.createElement('div');
        wrapper.className = `d-flex flex-column mb-2 ${isMine ? 'align-items-end' : 'align-items-start'}`;

        let html = '';

        // ìƒëŒ€ë°© ì´ë¦„ (ë§í’ì„  ìœ„)
        if (!isMine) {
          html += `<span class="text-secondary ms-1 mb-1" style="font-size: 0.75rem;">${msg.senderNickname}</span>`;
        }

        // ë§í’ì„ 
        let contentHtml = '';
        if (msg.type === 'IMAGE') {
          contentHtml = `<img src="${msg.content}" style="max-width: 100%; border-radius: 8px; cursor: pointer;" onclick="window.open(this.src)">`;
        } else {
          contentHtml = `<span>${msg.content}</span>`;
        }

        html += `<div class="message ${isMine ? 'sent' : 'received'}">${contentHtml}</div>`;

        wrapper.innerHTML = html;
        chatMessages.appendChild(wrapper);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      if (sendBtn) sendBtn.addEventListener('click', sendMessage);
      if (textarea) {
        textarea.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
          }
        });
      }
    });
  </script>
</th:block>
</html>
