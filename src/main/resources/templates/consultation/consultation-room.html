<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{common/layout/base}">

<head>
  <title>ìƒë‹´ ì±„íŒ…ë°©</title>
  <link rel="stylesheet" th:href="@{/css/consultation/consultation-room.css}">
  <style>
    .nav-tabs .nav-link {
      color: #666;
      font-weight: bold;
      border: none;
      transition: 0.2s;
    }

    .nav-tabs .nav-link.active {
      color: var(--color-primary);
      background: #fff;
      border-bottom: 2px solid var(--color-primary);
    }

    .file-item {
      transition: background 0.2s;
      cursor: default;
    }

    .file-item:hover {
      background-color: #f8f9fa;
    }

    .file-info-container {
      min-width: 0;
      flex: 1;
    }

    .chat-messages {
      overflow-y: auto;
      display: flex;
      flex-direction: column;
    }

    /* ë¡œë”© ì• ë‹ˆë©”ì´ì…˜ ìŠ¤íƒ€ì¼ */
    .upload-loading {
      opacity: 0.7;
    }

    /* íŒŒì¼ ëª©ë¡ ì»¨í…Œì´ë„ˆ ìŠ¤í¬ë¡¤ë°” ì»¤ìŠ¤í…€ */
    #fileListContainer::-webkit-scrollbar {
      width: 6px;
    }

    #fileListContainer::-webkit-scrollbar-thumb {
      background-color: #e2e8f0; /* ì—°í•œ íšŒìƒ‰ */
      border-radius: 10px;
    }

    #fileListContainer::-webkit-scrollbar-track {
      background-color: transparent;
    }

    /* ëª©ë¡ ì•„ì´í…œ ê°„ê²© ë¯¸ì„¸ ì¡°ì • */
    .file-item {
      border-bottom: 1px solid #f1f5f9 !important;
    }

    .file-item:last-child {
      border-bottom: none !important;
    }
  </style>
</head>

<div layout:fragment="content">
  <th:block
    th:with="opponent=${consultationRoomDto.participants.get(0).memberId == consultationRoomDto.currentMemberId ? consultationRoomDto.participants.get(1) : consultationRoomDto.participants.get(0)}">

    <div class="mb-4">
      <h2 class="fw-bold">ğŸ’¬ ìƒë‹´ ì±„íŒ…ë°©</h2>
      <p class="text-small">
        <span class="fw-bold" th:text="${opponent.nickname}">ìƒëŒ€ë°©</span>ë‹˜ê³¼ì˜ ëŒ€í™”ì…ë‹ˆë‹¤.
      </p>
    </div>

    <div class="row g-4">
      <div class="col-lg-8">
        <div class="chat-container">
          <div class="chat-header">
            <div class="d-flex align-items-center">
              <div class="me-3">
                <img th:if="${opponent.profileUrl != null}" th:src="${opponent.profileUrl}" class="rounded-circle"
                     style="width: 40px; height: 40px; border: 1px solid var(--color-border); object-fit: cover;">
                <div th:unless="${opponent.profileUrl != null}"
                     class="bg-light rounded-circle d-flex align-items-center justify-content-center border"
                     style="width: 40px; height: 40px;">
                  <i class="bi bi-person-fill text-secondary fs-5"></i>
                </div>
              </div>
              <div>
                <div class="fw-bold" th:text="${opponent.nickname}">ë‹‰ë„¤ì„</div>
                <div class="text-small text-secondary text-truncate" style="max-width: 150px;">ì°¸ì—¬ì</div>
              </div>
            </div>
            <div>
              <button id="exit-btn" class="btn btn-sm btn-outline-custom">ë‚˜ê°€ê¸°</button>
            </div>
          </div>

          <div class="chat-messages" id="chatMessages">
            <div id="loadingIndicator" class="text-center my-3 d-none w-100">
              <div class="spinner-border spinner-border-sm text-secondary" role="status"></div>
              <small class="text-secondary ms-2">ì´ì „ ë©”ì‹œì§€ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</small>
            </div>

            <th:block th:each="message : ${consultationRoomDto.messageDtoList}">
              <div th:if="${message.type.name() == 'SYSTEM'}" class="d-flex justify-content-center my-3 w-100"
                   th:attr="data-id=${message.id}">
                <span class="badge bg-light text-secondary fw-normal border px-3 py-2 rounded-pill"
                      th:text="${message.content}">ì‹œìŠ¤í…œ</span>
              </div>

              <div th:unless="${message.type.name() == 'SYSTEM'}" class="d-flex flex-column mb-2"
                   th:attr="data-id=${message.id}"
                   th:classappend="${message.senderId == consultationRoomDto.currentMemberId} ? 'align-items-end' : 'align-items-start'">
                <span th:if="${message.senderId != consultationRoomDto.currentMemberId}"
                      th:text="${message.senderNickname}" class="text-secondary ms-1 mb-1" style="font-size: 0.75rem;">ë‹‰ë„¤ì„</span>
                <div class="message"
                     th:classappend="${message.senderId == consultationRoomDto.currentMemberId} ? 'sent' : 'received'">
                  <div th:if="${message.type.name() == 'IMAGE'}">
                    <img th:src="${message.content}" alt="ì´ë¯¸ì§€"
                         style="max-width: 250px; border-radius: 8px; cursor: pointer;" onclick="window.open(this.src)">
                    <div class="small mt-1" style="font-size: 0.7rem;"
                         th:classappend="${message.senderId == consultationRoomDto.currentMemberId} ? 'text-white-50' : 'text-muted'"
                         th:text="${message.fileName}">íŒŒì¼ëª…
                    </div>
                  </div>
                  <div th:if="${message.type.name() == 'FILE'}">
                    <a th:href="${message.content}" target="_blank"
                       class="text-decoration-none d-flex align-items-center p-1" style="color: inherit;">
                      <i class="bi bi-file-earmark-arrow-down fs-4 me-2"></i>
                      <div class="text-truncate" style="max-width: 150px;">
                        <small class="d-block" style="font-size: 0.7rem;"
                               th:classappend="${message.senderId == consultationRoomDto.currentMemberId} ? 'text-white-50' : ''">íŒŒì¼
                          ë‹¤ìš´ë¡œë“œ</small>
                        <span style="font-size: 0.85rem;"
                              th:text="${message.fileName != null ? message.fileName : 'ì²¨ë¶€íŒŒì¼'}">íŒŒì¼ëª…</span>
                      </div>
                    </a>
                  </div>
                  <span th:if="${message.type.name() == 'TEXT'}" th:text="${message.content}">ë‚´ìš©</span>
                </div>
              </div>
            </th:block>
          </div>

          <div class="chat-input-area">
            <input type="file" id="fileInput" style="display: none;">
            <button id="file-trigger-btn" class="btn btn-outline-custom px-2" title="íŒŒì¼ ì²¨ë¶€">
              <i class="bi bi-paperclip fs-5"></i>
            </button>
            <textarea class="chat-input" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." rows="1"></textarea>
            <button id="send-btn" class="btn btn-primary-custom">ì „ì†¡</button>
          </div>
        </div>
      </div>

      <div class="col-lg-4">
        <div class="card-custom shadow-sm sticky-top"
             style="top: 20px; border: 1px solid var(--color-border) !important;">
          <ul class="nav nav-tabs nav-fill border-0 bg-light rounded-top-4" id="sideTab" role="tablist">
            <li class="nav-item">
              <button class="nav-link active py-3" id="info-tab" data-bs-toggle="tab" data-bs-target="#info-pane"
                      type="button">ìƒë‹´ ì •ë³´
              </button>
            </li>
            <li class="nav-item">
              <button class="nav-link py-3" id="file-tab" data-bs-toggle="tab" data-bs-target="#file-pane" type="button"
                      onclick="loadChatFiles()">íŒŒì¼ ëª¨ìŒ
              </button>
            </li>
          </ul>

          <div class="tab-content p-4" id="sideTabContent">
            <div class="tab-pane fade show active" id="info-pane" role="tabpanel">
              <div class="mb-4">
                <label class="text-secondary small fw-bold mb-1">ìƒë‹´ ì œëª©</label>
                <div class="fw-bold text-dark"
                     th:text="${consultationRoomDto.consultingApplicationDetailResponse.title}">ì œëª©
                </div>
              </div>
              <div class="mb-4">
                <label class="text-secondary small fw-bold mb-1">ì¹´í…Œê³ ë¦¬</label>
                <div>
                  <span class="badge fw-bold border"
                        style="background-color: #e7f1ff !important; color: #0d6efd !important;"
                        th:text="${consultationRoomDto.consultingApplicationDetailResponse.category}">ì¹´í…Œê³ ë¦¬</span>
                </div>
              </div>
              <div class="mb-4">
                <label class="text-secondary small fw-bold mb-1">ê³ ë¯¼ ë‚´ìš©</label>
                <div class="bg-light p-3 rounded-3 small text-muted"
                     style="white-space: pre-wrap; max-height: 250px; overflow-y: auto; line-height: 1.6;"
                     th:text="${consultationRoomDto.consultingApplicationDetailResponse.content}">ë‚´ìš©
                </div>
              </div>
            </div>

            <div class="tab-pane fade" id="file-pane" role="tabpanel">
              <div id="fileListContainer" class="d-flex flex-column"
                   style="max-height: 500px; overflow-y: auto;">
                <p class="text-center text-secondary small py-5">ê³µìœ ëœ íŒŒì¼ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </th:block>
</div>

<th:block layout:fragment="script">
  <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>

  <script th:inline="javascript">
    document.addEventListener('DOMContentLoaded', function () {
      const chatMessages = document.getElementById('chatMessages');
      const textarea = document.querySelector('.chat-input');
      const sendBtn = document.getElementById('send-btn');
      const fileInput = document.getElementById('fileInput');
      const fileTriggerBtn = document.getElementById('file-trigger-btn');
      const fileListContainer = document.getElementById('fileListContainer');

      const roomId = [[${consultationRoomDto.consultationRoomId}]];
      const currentMemberId = [[${consultationRoomDto.currentMemberId}]];
      const roomStatus = [[${consultationRoomDto.roomStatus.name()}]];

      let stompClient = null;

      if (roomStatus !== 'CLOSED') connectWebSocket();
      chatMessages.scrollTop = chatMessages.scrollHeight;

      sendBtn.addEventListener('click', sendMessage);
      fileTriggerBtn.addEventListener('click', () => fileInput.click());
      fileInput.addEventListener('change', uploadFile);

      // 1. íŒŒì¼ ì‹¤ì œ ë‹¤ìš´ë¡œë“œ (ê¸°ì¡´ ë¡œì§)
      window.downloadFile = async function (fileUrl, fileName) {
        try {
          const response = await fetch(fileUrl);
          const blob = await response.blob();
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = fileName;
          document.body.appendChild(a);
          a.click();
          window.URL.revokeObjectURL(url);
          document.body.removeChild(a);
        } catch (e) {
          window.open(fileUrl, '_blank');
        }
      };

      // 2. íŒŒì¼ ì—…ë¡œë“œ (ë¡œë”© í‘œì‹œ ì¶”ê°€)
      async function uploadFile() {
        const file = fileInput.files[0];
        if (!file) return;

        // ì„ì‹œ ë¡œë”© ë§í’ì„  ì•„ì´ë””
        const tempId = 'up-' + Date.now();

        // ë¡œë”©ìš© ë§í’ì„  ì¶”ê°€
        const loadingHtml = `
          <div id="${tempId}" class="d-flex flex-column mb-2 align-items-end upload-loading">
            <div class="message sent d-flex align-items-center">
              <div class="spinner-border spinner-border-sm me-2" role="status"></div>
              <span style="font-size: 0.85rem;">íŒŒì¼ ì—…ë¡œë“œ ì¤‘... (${file.name})</span>
            </div>
          </div>`;
        chatMessages.insertAdjacentHTML('beforeend', loadingHtml);
        chatMessages.scrollTop = chatMessages.scrollHeight;

        const formData = new FormData();
        formData.append("file", file);

        try {
          const response = await fetch(`/api/consultations/room/${roomId}/file`, {
            method: 'POST',
            body: formData
          });
          if (!response.ok) throw new Error();

          // ì„±ê³µ ì‹œ ë¡œë”© ë§í’ì„  ì œê±° (ì›¹ì†Œì¼“ìœ¼ë¡œ ì‹¤ì œ ë©”ì‹œì§€ê°€ ì˜¬ ê²ƒì´ê¸° ë•Œë¬¸)
          document.getElementById(tempId)?.remove();
        } catch (error) {
          const tempEl = document.getElementById(tempId);
          if (tempEl) tempEl.innerHTML = `<div class="message sent bg-danger text-white">ì—…ë¡œë“œ ì‹¤íŒ¨</div>`;
          setTimeout(() => tempEl?.remove(), 2000);
        } finally {
          fileInput.value = "";
        }
      }

      // 3. ë©”ì‹œì§€ ë Œë”ë§ (ì‹¤ì‹œê°„ ìˆ˜ì‹  ì‹œ í˜¸ì¶œ)
      function createMessageElement(msg) {
        const wrapper = document.createElement('div');
        wrapper.setAttribute('data-id', msg.id);

        if (msg.type === 'SYSTEM') {
          wrapper.className = 'd-flex justify-content-center my-3 w-100';
          wrapper.innerHTML = `<span class="badge bg-light text-secondary fw-normal border px-3 py-2 rounded-pill">${msg.content}</span>`;
        } else {
          const isMine = (msg.senderId == currentMemberId);
          const fileName = msg.fileName || "ì²¨ë¶€íŒŒì¼";
          wrapper.className = `d-flex flex-column mb-2 ${isMine ? 'align-items-end' : 'align-items-start'}`;

          let contentHtml = '';
          if (msg.type === 'IMAGE') {
            contentHtml = `<img src="${msg.content}" style="max-width: 250px; border-radius: 8px; cursor: pointer;" onclick="window.open(this.src)">
                           <div class="small text-muted mt-1" style="font-size: 0.7rem;">${fileName}</div>`;
          } else if (msg.type === 'FILE') {
            contentHtml = `<a href="${msg.content}" target="_blank" class="text-decoration-none d-flex align-items-center p-2" style="color: inherit;">
                             <i class="bi bi-file-earmark-arrow-down fs-4 me-2"></i>
                             <div><small class="d-block" style="font-size: 0.7rem;">íŒŒì¼ ë‹¤ìš´ë¡œë“œ</small><span style="font-size: 0.85rem;">${fileName}</span></div>
                           </a>`;
          } else {
            contentHtml = `<span>${msg.content}</span>`;
          }

          wrapper.innerHTML = (!isMine ? `<span class="text-secondary ms-1 mb-1" style="font-size: 0.75rem;">${msg.senderNickname}</span>` : '') +
            `<div class="message ${isMine ? 'sent' : 'received'}">${contentHtml}</div>`;
        }
        return wrapper;
      }

      function connectWebSocket() {
        const socket = new SockJS('/ws');
        stompClient = Stomp.over(socket);
        stompClient.connect({}, function () {
          stompClient.subscribe('/topic/room/' + roomId, function (res) {
            appendMessage(JSON.parse(res.body));
          });
        });
      }

      function appendMessage(msg) {
        const messageElement = createMessageElement(msg);
        chatMessages.appendChild(messageElement);

        // ë©”ì‹œì§€ ë‚´ë¶€ì— ì´ë¯¸ì§€ê°€ ìˆëŠ”ì§€ í™•ì¸
        const img = messageElement.querySelector('img');
        if (img) {
          // ì´ë¯¸ì§€ê°€ ë¡œë“œ ì™„ë£Œë˜ë©´ ìŠ¤í¬ë¡¤ì„ ë§¨ ì•„ë˜ë¡œ ì´ë™
          img.addEventListener('load', () => {
            chatMessages.scrollTop = chatMessages.scrollHeight;
          });
        } else {
          // ì¼ë°˜ í…ìŠ¤íŠ¸ë‚˜ íŒŒì¼ì˜ ê²½ìš° ì¦‰ì‹œ ìŠ¤í¬ë¡¤ ì´ë™
          chatMessages.scrollTop = chatMessages.scrollHeight;
        }
      }

      function sendMessage() {
        const content = textarea.value.trim();
        if (content && stompClient?.connected) {
          stompClient.send("/app/chat/send", {}, JSON.stringify({
            'roomId': roomId,
            'senderId': currentMemberId,
            'content': content
          }));
          textarea.value = '';
        }
      }

      window.loadChatFiles = async function () {
        // ë¡œë”© ì‹œì—ë„ ìŠ¤í¬ë¡¤ ì˜ì—­ì´ ìœ ì§€ë˜ë„ë¡ ì²˜ë¦¬
        fileListContainer.innerHTML = '<div class="text-center py-5"><div class="spinner-border spinner-border-sm text-secondary"></div></div>';

        try {
          const response = await fetch(`/api/consultations/room/${roomId}/files`);
          const result = await response.json();
          const files = result.data;

          if (!files || files.length === 0) {
            fileListContainer.innerHTML = '<p class="text-center text-secondary small py-5">ê³µìœ ëœ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
            return;
          }
          fileListContainer.innerHTML = files.map(file => {
            const isImg = (file.type === 'IMAGE');
            const displayFileName = file.fileName || "íŒŒì¼";
            return `<div class="file-item border-bottom p-3 d-flex align-items-center justify-content-between">
                      <div class="file-info-container d-flex align-items-center me-2">
                        <i class="bi ${isImg ? 'bi-image text-success' : 'bi-file-earmark-text text-primary'} fs-5 me-3"></i>
                        <div class="overflow-hidden">
                          <div class="text-dark fw-bold text-truncate small" title="${displayFileName}">${displayFileName}</div>
                          <div class="text-secondary" style="font-size: 0.7rem;">${file.senderNickname}ë‹˜</div>
                        </div>
                      </div>
                      <button type="button" class="btn btn-sm btn-light border-0" onclick="downloadFile('${file.content}', '${displayFileName.replace(/'/g, "\\'")}')">
                        <i class="bi bi-download text-secondary"></i>
                      </button>
                    </div>`;
          }).join('');

          fileListContainer.scrollTop = 0;
        } catch (e) {
          fileListContainer.innerHTML = '<p class="text-center text-danger small py-5">íŒŒì¼ ë¡œë“œ ì‹¤íŒ¨</p>';
        }
      };
    });
  </script>
</th:block>
</html>
