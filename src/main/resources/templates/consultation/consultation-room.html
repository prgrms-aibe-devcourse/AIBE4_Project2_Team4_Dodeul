<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{common/layout/base}">

<head>
  <title>ìƒë‹´ ì±„íŒ…ë°©</title>
  <link rel="stylesheet" th:href="@{/css/consultation/consultation-room.css}">
</head>

<div layout:fragment="content">
  <th:block th:with="opponent=${consultationRoomDto.participants.get(0).memberId == consultationRoomDto.currentMemberId ? consultationRoomDto.participants.get(1) : consultationRoomDto.participants.get(0)}">

    <div class="mb-4">
      <h2 class="fw-bold">ğŸ’¬ ìƒë‹´ ì±„íŒ…ë°©</h2>
      <p class="text-small">
        <span class="fw-bold" th:text="${opponent.nickname}">ìƒëŒ€ë°©</span>ë‹˜ê³¼ì˜ ëŒ€í™”ì…ë‹ˆë‹¤.
      </p>
    </div>

    <div class="row g-4">
      <div class="col-lg-8">
        <div class="chat-container">
          <div class="chat-header">
            <div class="d-flex align-items-center">
              <div class="me-3">
                <img th:if="${opponent.profileUrl != null}" th:src="${opponent.profileUrl}" class="rounded-circle" style="width: 40px; height: 40px; border: 1px solid var(--color-border); object-fit: cover;">
                <div th:unless="${opponent.profileUrl != null}" class="bg-light rounded-circle d-flex align-items-center justify-content-center border" style="width: 40px; height: 40px;">
                  <i class="bi bi-person-fill text-secondary fs-5"></i>
                </div>
              </div>
              <div>
                <div class="fw-bold" th:text="${opponent.nickname}">ë‹‰ë„¤ì„</div>
                <div class="text-small text-secondary">
                  <span class="badge bg-light text-dark border rounded-pill">ì°¸ì—¬ì</span>
                </div>
              </div>
            </div>
            <div>
              <button id="exit-btn" class="btn btn-sm btn-outline-custom">
                <i class="bi bi-box-arrow-right me-1"></i>ë‚˜ê°€ê¸°
              </button>
            </div>
          </div>

          <div class="chat-messages" id="chatMessages">
            <div id="loadingIndicator" class="text-center my-3 d-none w-100">
              <div class="spinner-border spinner-border-sm text-secondary" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
              <small class="text-secondary ms-2">ì´ì „ ë©”ì‹œì§€ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</small>
            </div>

            <th:block th:each="message : ${consultationRoomDto.messageDtoList}">
              <div th:if="${message.type.name() == 'SYSTEM'}" class="d-flex justify-content-center my-3 w-100" th:attr="data-id=${message.id}">
                <span class="badge bg-light text-secondary fw-normal border px-3 py-2 rounded-pill" th:text="${message.content}">ì‹œìŠ¤í…œ</span>
              </div>

              <div th:unless="${message.type.name() == 'SYSTEM'}" class="d-flex flex-column mb-2" th:attr="data-id=${message.id}" th:classappend="${message.senderId == consultationRoomDto.currentMemberId} ? 'align-items-end' : 'align-items-start'">
                <span th:if="${message.senderId != consultationRoomDto.currentMemberId}" th:text="${message.senderNickname}" class="text-secondary ms-1 mb-1" style="font-size: 0.75rem;">ë‹‰ë„¤ì„</span>
                <div class="message" th:classappend="${message.senderId == consultationRoomDto.currentMemberId} ? 'sent' : 'received'">
                  <div th:if="${message.type.name() == 'IMAGE'}">
                    <img th:src="${message.content}" alt="ì´ë¯¸ì§€" style="max-width: 250px; border-radius: 8px; cursor: pointer;" onclick="window.open(this.src)">
                  </div>
                  <div th:if="${message.type.name() == 'FILE'}">
                    <a th:href="${message.content}" target="_blank" class="text-decoration-none d-flex align-items-center p-1" style="color: inherit;">
                      <i class="bi bi-file-earmark-arrow-down fs-4 me-2"></i>
                      <div class="text-truncate" style="max-width: 150px;">
                        <small class="d-block" style="font-size: 0.7rem;">íŒŒì¼ ë‹¤ìš´ë¡œë“œ</small>
                        <span style="font-size: 0.85rem;">ì²¨ë¶€íŒŒì¼</span>
                      </div>
                    </a>
                  </div>
                  <span th:if="${message.type.name() == 'TEXT'}" th:text="${message.content}">ë‚´ìš©</span>
                </div>
              </div>
            </th:block>
          </div>

          <div class="chat-input-area">
            <button class="btn btn-outline-custom px-2" title="íŒŒì¼ ì²¨ë¶€">
              <i class="bi bi-paperclip fs-5"></i>
            </button>
            <textarea class="chat-input" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." rows="1"></textarea>
            <button id="send-btn" class="btn btn-primary-custom" style="height: 48px; padding-left: 1.5rem; padding-right: 1.5rem;">ì „ì†¡</button>
          </div>
        </div>
      </div>

      <div class="col-lg-4">
      </div>
    </div>
  </th:block>

  <div class="modal fade" id="exitModal" tabindex="-1" aria-labelledby="exitModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content border-0 shadow">

        <div class="modal-header border-0 pb-0">
          <h5 class="modal-title fw-bold" id="exitModalLabel">ìƒë‹´ì„ ì¢…ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>

        <th:block th:if="${consultationRoomDto.currentMemberId == consultationRoomDto.menteeId}">
          <div class="modal-body py-4">
            <p class="text-secondary mb-0">
              ìƒë‹´ì„ ì¢…ë£Œí•˜ë©´ ë” ì´ìƒ ë©”ì‹œì§€ë¥¼ ë³´ë‚¼ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.<br>
              ìƒë‹´ì€ ë§Œì¡±ìŠ¤ëŸ¬ìš°ì…¨ë‚˜ìš”? <strong>ë¦¬ë·°ë¥¼ ë‚¨ê²¨ì£¼ì„¸ìš”!</strong>
            </p>
          </div>
          <div class="modal-footer border-0 pt-0">
            <button type="button" class="btn btn-light px-4" data-bs-dismiss="modal">ì·¨ì†Œ</button>
            <button type="button" id="mentee-exit-btn" class="btn btn-primary-custom px-4">
              ì¢…ë£Œ ë° ë¦¬ë·° ì‘ì„±í•˜ê¸°
            </button>
          </div>
        </th:block>

        <th:block th:unless="${consultationRoomDto.currentMemberId == consultationRoomDto.menteeId}">
          <div class="modal-body py-4">
            <p class="text-secondary mb-0">
              ìƒë‹´ì„ ì¢…ë£Œí•˜ë©´ ëŒ€í™”ê°€ ì¤‘ë‹¨ë©ë‹ˆë‹¤.<br>
              ì •ë§ë¡œ ì¢…ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?
            </p>
          </div>
          <div class="modal-footer border-0 pt-0">
            <button type="button" class="btn btn-light px-4" data-bs-dismiss="modal">ì·¨ì†Œ</button>
            <button type="button" id="mentor-exit-btn" class="btn btn-danger px-4">
              ìƒë‹´ ì¢…ë£Œí•˜ê¸°
            </button>
          </div>
        </th:block>

      </div>
    </div>
  </div>
</div>

<th:block layout:fragment="script">
  <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>

  <script th:inline="javascript">
    document.addEventListener('DOMContentLoaded', function () {
      const chatMessages = document.getElementById('chatMessages');
      const textarea = document.querySelector('.chat-input');
      const sendBtn = document.getElementById('send-btn');
      const exitBtn = document.getElementById('exit-btn'); // í—¤ë”ì˜ ë‚˜ê°€ê¸° ë²„íŠ¼
      const loadingIndicator = document.getElementById('loadingIndicator');

      // ëª¨ë‹¬ ë²„íŠ¼ (ë©˜í‹°/ë©˜í†  ë¶„ê¸°)
      const menteeExitBtn = document.getElementById('mentee-exit-btn');
      const mentorExitBtn = document.getElementById('mentor-exit-btn');

      const exitModalElement = document.getElementById('exitModal');
      const exitModal = new bootstrap.Modal(exitModalElement);

      const roomId = [[${consultationRoomDto.consultationRoomId}]];
      const matchingId = [[${consultationRoomDto.matchingId}]]; // ë¦¬ë·° í˜ì´ì§€ ì´ë™ìš©
      const currentMemberId = [[${consultationRoomDto.currentMemberId}]];
      const roomStatus = [[${consultationRoomDto.roomStatus.name()}]];

      let isFetching = false;
      let hasNext = true;
      let lastMessageId = null;
      let stompClient = null;

      // ì´ˆê¸° ì„¤ì •
      if (roomStatus === 'CLOSED') {
        hideChatInput();
      } else {
        connectWebSocket();
      }

      if (chatMessages) {
        chatMessages.scrollTop = chatMessages.scrollHeight;
        updateCursor();
      }

      // ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ì—°ê²°
      if (exitBtn) exitBtn.addEventListener('click', () => exitModal.show());
      if (sendBtn) sendBtn.addEventListener('click', sendMessage);

      textarea.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });

      chatMessages.addEventListener('scroll', () => {
        if (chatMessages.scrollTop === 0 && hasNext && !isFetching) fetchPreviousMessages();
      });

      // [í•µì‹¬ ë¡œì§] ë©˜í‹° ë²„íŠ¼: ì¢…ë£Œ í›„ ë¦¬ë·° í˜ì´ì§€ ì´ë™
      if (menteeExitBtn) {
        menteeExitBtn.addEventListener('click', async () => {
          const success = await requestCloseRoom();
          if (success) {
            location.href = `/reviews/new/${matchingId}`;
          }
        });
      }

      // [í•µì‹¬ ë¡œì§] ë©˜í†  ë²„íŠ¼: ì¢…ë£Œ í›„ ëª©ë¡ ì´ë™
      if (mentorExitBtn) {
        mentorExitBtn.addEventListener('click', async () => {
          const success = await requestCloseRoom();
          if (success) {
            alert("ìƒë‹´ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
            location.href = '/mentor/dashboard';
          }
        });
      }

      // --- ê¸°ëŠ¥ í•¨ìˆ˜ë“¤ ---

      function connectWebSocket() {
        const socket = new SockJS('/ws');
        stompClient = Stomp.over(socket);
        stompClient.connect({}, function () {
          stompClient.subscribe('/topic/room/' + roomId, function (response) {
            const msg = JSON.parse(response.body);
            appendMessage(msg);
            if (msg.type === 'SYSTEM' && msg.content.includes("ì¢…ë£Œ")) handleRoomClosed();
          });
        });
      }

// --- [ìˆ˜ì •ëœ í•¨ìˆ˜] ì¢…ë£Œ ìš”ì²­ ì²˜ë¦¬ ---
      async function requestCloseRoom() {
        try {
          const response = await fetch(`/api/consultations/room/${roomId}/close`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
          });

          // 1. ì •ìƒ ì¢…ë£Œ (200 OK)
          if (response.ok) {
            handleRoomClosed();
            exitModal.hide();
            return true;
          }

          // 2. ì—ëŸ¬ ì‘ë‹µ ì²˜ë¦¬
          const result = await response.json();

          // [í•µì‹¬] 409 Conflict (ì´ë¯¸ ì¢…ë£Œë¨) ì—ëŸ¬ê°€ ë°œìƒí–ˆëŠ”ì§€ í™•ì¸
          // ë°±ì—”ë“œì—ì„œ ì„¤ì •í•œ HttpStatus.CONFLICTê°€ 409ì…ë‹ˆë‹¤.
          // result.codeê°€ 'RESOURCE_CONFLICT' ì¸ì§€ í™•ì¸ (CommonResponse êµ¬ì¡°ì— ë”°ë¼ ë‹¤ë¥¼ ìˆ˜ ìˆìŒ)
          if (response.status === 409 || result.code === 'RESOURCE_CONFLICT' || result.message.includes('ì´ë¯¸ ì¢…ë£Œ')) {
            console.log("ì´ë¯¸ ì¢…ë£Œëœ ìƒë‹´ë°©ì…ë‹ˆë‹¤. (ì„±ê³µ ì²˜ë¦¬)");

            handleRoomClosed(); // ì›¹ì†Œì¼“ í•´ì œ ë° ì…ë ¥ì°½ ìˆ¨ê¸°ê¸°
            exitModal.hide();   // ëª¨ë‹¬ ë‹«ê¸°
            return true;        // â˜… ì„±ê³µ(true)ìœ¼ë¡œ ë°˜í™˜í•˜ì—¬ ë‹¤ìŒ í˜ì´ì§€ ì´ë™ ë¡œì§ ì‹¤í–‰
          }

          // 3. ê·¸ ì™¸ ì§„ì§œ ì—ëŸ¬ (500 ë“±)
          alert(result.message || "ìƒë‹´ ì¢…ë£Œ ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
          return false;

        } catch (error) {
          console.error("ì¢…ë£Œ ìš”ì²­ ì‹¤íŒ¨:", error);
          alert("ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
          return false;
        }
      }

      function handleRoomClosed() {
        hideChatInput();
        if (stompClient && stompClient.connected) {
          stompClient.disconnect(() => console.log("ìƒë‹´ ì¢…ë£Œ: WebSocket ì—°ê²° í•´ì œ"));
        }
      }

      function hideChatInput() {
        const inputArea = document.querySelector('.chat-input-area');
        if (inputArea) inputArea.style.display = 'none';
      }

      function createMessageElement(msg) {
        const wrapper = document.createElement('div');
        wrapper.setAttribute('data-id', msg.id);
        if (msg.type === 'SYSTEM') {
          wrapper.className = 'd-flex justify-content-center my-3 w-100';
          wrapper.innerHTML = `<span class="badge bg-light text-secondary fw-normal border px-3 py-2 rounded-pill">${msg.content}</span>`;
        } else {
          const isMine = (msg.senderId == currentMemberId);
          wrapper.className = `d-flex flex-column mb-2 ${isMine ? 'align-items-end' : 'align-items-start'}`;
          let contentHtml = msg.type === 'IMAGE'
            ? `<img src="${msg.content}" style="max-width: 250px; border-radius: 8px; cursor: pointer;" onclick="window.open(this.src)">`
            : msg.type === 'FILE'
              ? `<a href="${msg.content}" target="_blank" class="text-decoration-none d-flex align-items-center p-2" style="color: inherit;"><i class="bi bi-file-earmark-arrow-down fs-4 me-2"></i><div><small class="d-block" style="font-size: 0.7rem;">íŒŒì¼ ë‹¤ìš´ë¡œë“œ</small><span style="font-size: 0.85rem;">ì²¨ë¶€íŒŒì¼</span></div></a>`
              : `<span>${msg.content}</span>`;
          wrapper.innerHTML = (!isMine ? `<span class="text-secondary ms-1 mb-1" style="font-size: 0.75rem;">${msg.senderNickname}</span>` : '') + `<div class="message ${isMine ? 'sent' : 'received'}">${contentHtml}</div>`;
        }
        return wrapper;
      }

      function appendMessage(msg) { chatMessages.appendChild(createMessageElement(msg)); chatMessages.scrollTop = chatMessages.scrollHeight; }
      function prependMessage(msg) { chatMessages.insertBefore(createMessageElement(msg), chatMessages.firstChild); }
      function updateCursor() { const first = chatMessages.querySelector('[data-id]'); if (first) lastMessageId = first.getAttribute('data-id'); }

      async function fetchPreviousMessages() {
        if (!lastMessageId) return;
        isFetching = true;
        loadingIndicator.classList.remove('d-none');
        const prevHeight = chatMessages.scrollHeight;
        try {
          const response = await fetch(`/api/consultations/room/${roomId}/messages?lastMessageId=${lastMessageId}&size=20`);
          const result = await response.json();
          const data = result.data;
          if (data.content && data.content.length > 0) {
            data.content.forEach(msg => prependMessage(msg));
            updateCursor();
            hasNext = !data.last;
            chatMessages.scrollTop = chatMessages.scrollHeight - prevHeight;
          } else hasNext = false;
        } finally { isFetching = false; loadingIndicator.classList.add('d-none'); }
      }

      function sendMessage() {
        const content = textarea.value.trim();
        if (content && stompClient && stompClient.connected) {
          stompClient.send("/app/chat/send", {}, JSON.stringify({ 'roomId': roomId, 'senderId': currentMemberId, 'content': content }));
          textarea.value = '';
        }
      }
    });
  </script>
</th:block>
</html>
