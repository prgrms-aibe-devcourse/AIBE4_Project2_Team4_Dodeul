<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{common/layout/base}">

<head>
  <title>ìƒë‹´ ì±„íŒ…ë°©</title>
  <link rel="stylesheet" th:href="@{/css/consultation/chat-main.css}">
  <link rel="stylesheet" th:href="@{/css/consultation/sidebar-info.css}">
  <link rel="stylesheet" th:href="@{/css/consultation/sidebar-files.css}">
</head>

<div layout:fragment="content">
  <th:block th:with="opponent=${consultationRoomDto.participants.get(0).memberId == consultationRoomDto.currentMemberId ? consultationRoomDto.participants.get(1) : consultationRoomDto.participants.get(0)}">

    <div class="mb-4">
      <h2 class="fw-bold">ğŸ’¬ ìƒë‹´ ì±„íŒ…ë°©</h2>
      <p class="text-small"><span class="fw-bold" th:text="${opponent.nickname}">ìƒëŒ€ë°©</span>ë‹˜ê³¼ì˜ ëŒ€í™”ì…ë‹ˆë‹¤.</p>
    </div>

    <div class="row g-4 chat-main-row">
      <div class="col-lg-8 h-100">
        <div th:replace="~{consultation/fragment-chat :: chatPanel}"></div>
      </div>

      <div class="col-lg-4 h-100">
        <div class="sidebar-card shadow-sm border rounded-4 overflow-hidden">
          <ul class="nav nav-tabs nav-fill border-0 bg-light" id="sideTab" role="tablist">
            <li class="nav-item">
              <button class="nav-link active py-3" data-bs-toggle="tab" data-bs-target="#info-pane">ìƒë‹´ ì •ë³´</button>
            </li>
            <li class="nav-item">
              <button class="nav-link py-3" data-bs-toggle="tab" data-bs-target="#file-pane" onclick="loadChatFiles()">íŒŒì¼ ëª¨ìŒ</button>
            </li>
          </ul>
          <div class="tab-content" id="sideTabContent">
            <div th:replace="~{consultation/fragment-info :: infoPanel}"></div>
            <div th:replace="~{consultation/fragment-files :: filePanel}"></div>
          </div>
        </div>
      </div>
    </div>
  </th:block>
</div>

<th:block layout:fragment="script">
  <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
  <script th:inline="javascript">
    document.addEventListener('DOMContentLoaded', function () {
      const roomId = [[${consultationRoomDto.consultationRoomId}]];
      const currentMemberId = [[${consultationRoomDto.currentMemberId}]];
      const roomStatus = [[${consultationRoomDto.roomStatus.name()}]];
      let stompClient = null;

      // 1. ì´ˆê¸°í™”
      if (roomStatus !== 'CLOSED') connectWebSocket();
      // ì±„íŒ…ì°½ ìŠ¤í¬ë¡¤ í•˜ë‹¨ ì´ë™ (ìš”ì†Œê°€ ì¡´ì¬í•  ê²½ìš°)
      setTimeout(() => {
        const chatMessages = document.getElementById('chatMessages');
        if(chatMessages) chatMessages.scrollTop = chatMessages.scrollHeight;
      }, 100);

      // 2. ì´ë²¤íŠ¸ ìœ„ì„ (ì—”í„°í‚¤, í´ë¦­ ë“± ëª¨ë“  ì´ë²¤íŠ¸ ì²˜ë¦¬)
      document.addEventListener('keydown', function(e) {
        // IDê°€ chatInputì¸ ìš”ì†Œì—ì„œ ë°œìƒí•œ ì´ë²¤íŠ¸ì¸ì§€ í™•ì¸
        if (e.target && e.target.id === 'chatInput') {
          if (e.isComposing) return; // í•œê¸€ ì¤‘ë³µ ì „ì†¡ ë°©ì§€
          if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
          }
        }
      });

      document.addEventListener('click', function(e) {
        // ì „ì†¡ ë²„íŠ¼
        if (e.target.id === 'send-btn' || e.target.closest('#send-btn')) sendMessage();
        // íŒŒì¼ ë²„íŠ¼
        if (e.target.id === 'file-trigger-btn' || e.target.closest('#file-trigger-btn')) document.getElementById('fileInput').click();
        // íŒŒì¼ ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ (ë™ì  ìƒì„±ëœ ë²„íŠ¼ ëŒ€ì‘)
        if (e.target.closest('.btn-download')) {
          const btn = e.target.closest('.btn-download');
          downloadFile(btn.dataset.url, btn.dataset.name);
        }
      });

      const fileInput = document.getElementById('fileInput');
      if(fileInput) fileInput.addEventListener('change', uploadFile);

      // 3. ê¸°ëŠ¥ í•¨ìˆ˜ë“¤
      function sendMessage() {
        const textarea = document.getElementById('chatInput');
        if (!textarea) return;

        const content = textarea.value.trim();
        if (content && stompClient?.connected) {
          stompClient.send("/app/chat/send", {}, JSON.stringify({
            'roomId': roomId,
            'senderId': currentMemberId,
            'content': content
          }));
          textarea.value = '';
          textarea.focus();
        }
      }

      function connectWebSocket() {
        const socket = new SockJS('/ws');
        stompClient = Stomp.over(socket);
        stompClient.connect({}, function () {
          stompClient.subscribe('/topic/room/' + roomId, function (res) {
            appendMessage(JSON.parse(res.body));
          });
        });
      }

      function appendMessage(msg) {
        const chatMessages = document.getElementById('chatMessages');
        if (!chatMessages) return;

        const wrapper = document.createElement('div');
        const isMine = (msg.senderId == currentMemberId);
        const fileName = msg.fileName || "ì²¨ë¶€íŒŒì¼";
        const fileNameClass = isMine ? 'text-white-50' : 'text-muted';
        wrapper.className = `d-flex flex-column mb-2 ${isMine ? 'align-items-end' : 'align-items-start'}`;

        let contentHtml = '';
        // JSì—ì„œ ë™ì ìœ¼ë¡œ ìƒì„±í•˜ëŠ” HTML (ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ì— ìœ„ì„ìš© í´ë˜ìŠ¤ ì¶”ê°€)
        if (msg.type === 'IMAGE') {
          contentHtml = `<img src="${msg.content}" style="max-width: 250px; min-height: 100px; background: #f0f0f0; border-radius: 8px; cursor: pointer;" onclick="window.open(this.src)"><div class="small mt-1 ${fileNameClass}" style="font-size: 0.7rem;">${fileName}</div>`;
        } else if (msg.type === 'FILE') {
          contentHtml = `<button class="btn-download text-decoration-none d-flex align-items-center p-2 border-0 bg-transparent" style="color: inherit;" data-url="${msg.content}" data-name="${fileName.replace(/"/g, '&quot;')}">
                           <i class="bi bi-file-earmark-arrow-down fs-4 me-2"></i>
                           <div class="text-start"><small class="d-block ${fileNameClass}" style="font-size: 0.7rem;">íŒŒì¼ ë‹¤ìš´ë¡œë“œ</small><span style="font-size: 0.85rem;">${fileName}</span></div>
                         </button>`;
        } else { contentHtml = `<span>${msg.content}</span>`; }

        wrapper.innerHTML = (!isMine ? `<span class="text-secondary ms-1 mb-1" style="font-size: 0.75rem;">${msg.senderNickname}</span>` : '') +
          `<div class="message ${isMine ? 'sent' : 'received'}">${contentHtml}</div>`;

        chatMessages.appendChild(wrapper);
        const img = wrapper.querySelector('img');
        if (img) img.addEventListener('load', () => chatMessages.scrollTop = chatMessages.scrollHeight);
        else chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      window.downloadFile = async function(fileUrl, fileName) {
        try {
          const response = await fetch(fileUrl);
          const blob = await response.blob();
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url; a.download = fileName;
          document.body.appendChild(a); a.click();
          window.URL.revokeObjectURL(url); document.body.removeChild(a);
        } catch (e) { window.open(fileUrl, '_blank'); }
      };

      async function uploadFile() {
        const file = fileInput.files[0]; if (!file) return;
        const chatMessages = document.getElementById('chatMessages');
        const tempId = 'up-' + Date.now();
        const loadingHtml = `<div id="${tempId}" class="d-flex flex-column mb-2 align-items-end upload-loading"><div class="message sent d-flex align-items-center"><div class="spinner-border spinner-border-sm me-2"></div><span style="font-size: 0.85rem;">ì—…ë¡œë“œ ì¤‘... (${file.name})</span></div></div>`;
        if(chatMessages) {
          chatMessages.insertAdjacentHTML('beforeend', loadingHtml);
          chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        const formData = new FormData(); formData.append("file", file);
        try {
          const response = await fetch(`/api/consultations/room/${roomId}/file`, { method: 'POST', body: formData });
          if (!response.ok) throw new Error();
          document.getElementById(tempId)?.remove();
        } catch (error) {
          const tempEl = document.getElementById(tempId);
          if (tempEl) tempEl.innerHTML = `<div class="message sent bg-danger text-white">ì—…ë¡œë“œ ì‹¤íŒ¨</div>`;
          setTimeout(() => tempEl?.remove(), 2000);
        } finally { fileInput.value = ""; }
      }

      window.loadChatFiles = async function() {
        const fileListContainer = document.getElementById('fileListContainer');
        if(!fileListContainer) return;
        fileListContainer.innerHTML = '<div class="text-center py-5"><div class="spinner-border spinner-border-sm text-secondary"></div></div>';
        try {
          const response = await fetch(`/api/consultations/room/${roomId}/files`);
          const result = await response.json();
          const files = result.data;
          if (!files || files.length === 0) {
            fileListContainer.innerHTML = '<p class="text-center text-secondary small py-5">ê³µìœ ëœ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
            return;
          }
          fileListContainer.innerHTML = files.map(file => {
            const displayFileName = file.fileName || "íŒŒì¼";
            return `<div class="file-item border-bottom p-3 d-flex align-items-center justify-content-between">
                      <div class="file-info-container d-flex align-items-center me-2">
                        <i class="bi ${file.type === 'IMAGE' ? 'bi-image text-success' : 'bi-file-earmark-text text-primary'} fs-5 me-3"></i>
                        <div class="overflow-hidden">
                          <div class="text-dark fw-bold text-truncate small" title="${displayFileName}">${displayFileName}</div>
                          <div class="text-secondary" style="font-size: 0.7rem;">${file.senderNickname}ë‹˜</div>
                        </div>
                      </div>
                      <button type="button" class="btn-download btn btn-sm btn-light border-0" data-url="${file.content}" data-name="${displayFileName.replace(/"/g, '&quot;')}">
                        <i class="bi bi-download text-secondary"></i>
                      </button>
                    </div>`;
          }).join('');
          fileListContainer.scrollTop = 0;
        } catch (e) { fileListContainer.innerHTML = '<p class="text-center text-danger small py-5">ë¡œë“œ ì‹¤íŒ¨</p>'; }
      };
    });
  </script>
</th:block>
</html>
