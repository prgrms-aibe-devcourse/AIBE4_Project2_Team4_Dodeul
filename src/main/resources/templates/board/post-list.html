<!-- src/main/resources/templates/board/post-list.html -->
<!DOCTYPE html>
<html
  lang="ko"
  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
  xmlns:th="http://www.thymeleaf.org"
  layout:decorate="~{common/layout/base}"
>
<head>
  <th:block layout:fragment="head">
    <link rel="stylesheet" th:href="@{/css/board/board-post-list.css}"/>
  </th:block>
</head>

<body>
<section layout:fragment="content">
  <main class="board-list">
    <header class="board-list__header">
      <div class="board-list__titlebox">
        <h1 class="board-list__title">ê³µê°œ ê²Œì‹œíŒ</h1>
        <p class="board-list__desc">ì§ˆë¬¸ì„ ì˜¬ë¦¬ê³  ë‹µë³€ì„ ë°›ì•„ë³´ì„¸ìš”.</p>
      </div>

      <div class="board-list__actions">
        <a class="btn btn--primary" href="/board/posts/new">ì§ˆë¬¸ ì‘ì„±</a>
      </div>
    </header>

    <section class="board-filters card">
      <div class="board-filters__row">
        <div class="field">
          <label class="field__label" for="keyword">ê²€ìƒ‰</label>
          <input id="keyword" class="field__input" type="text" placeholder="ì œëª©/ë³¸ë¬¸ í‚¤ì›Œë“œ"/>
        </div>

        <div class="field">
          <label class="field__label" for="status">ìƒíƒœ</label>
          <select id="status" class="field__select">
            <option value="">ì „ì²´</option>
            <option value="OPEN">OPEN</option>
            <option value="CLOSED">CLOSED</option>
          </select>
        </div>

        <div class="field">
          <label class="field__label" for="sort">ì •ë ¬</label>
          <select id="sort" class="field__select">
            <option value="LATEST">ìµœì‹ ìˆœ</option>
            <option value="VIEW">ì¡°íšŒìˆ˜ìˆœ</option>
            <option value="SCRAP">ìŠ¤í¬ë©ìˆœ</option>
            <option value="COMMENTED">ìµœê·¼ëŒ“ê¸€ìˆœ</option>
          </select>
        </div>

        <button id="applyBtn" class="btn" type="button">ì ìš©</button>
        <button id="resetBtn" class="btn btn--ghost" type="button">ì´ˆê¸°í™”</button>
      </div>

      <div class="board-filters__hint">
        ê²€ìƒ‰/í•„í„° ì‚¬ìš© ì‹œ ë¡œê·¸ì¸ ì •ì±…ì´ ì ìš©ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
      </div>
    </section>

    <section class="board-cards" aria-live="polite">
      <div id="emptyState" class="empty" style="display:none;">
        <div class="empty__title">ê²Œì‹œê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</div>
        <div class="empty__desc">ì²« ì§ˆë¬¸ì„ ì‘ì„±í•´ë³´ì„¸ìš”.</div>
      </div>

      <div id="cardList" class="board-cards__grid"></div>
    </section>

    <nav class="pager" aria-label="í˜ì´ì§€ë„¤ì´ì…˜">
      <button id="prevBtn" class="btn btn--ghost" type="button">ì´ì „</button>
      <div class="pager__info">
        <span id="pageInfo">1 / 1</span>
      </div>
      <button id="nextBtn" class="btn btn--ghost" type="button">ë‹¤ìŒ</button>
    </nav>
  </main>

  <script>
    (function () {
      const $ = (id) => document.getElementById(id);

      const state = {
        page: 0,
        size: 12,
        totalPages: 1,
        keyword: "",
        status: "",
        sort: "LATEST",
      };

      function fetchJson(url, options) {
        const base = {
          credentials: "include",
          headers: {Accept: "application/json"},
        };
        return fetch(url, {...base, ...(options || {})}).then((r) => (r.ok ? r.json() : Promise.reject(r)));
      }

      function getApiData(res) {
        return (res && res.data != null) ? res.data : res;
      }

      function buildQuery() {
        const params = new URLSearchParams();
        params.set("page", String(state.page));
        params.set("size", String(state.size));

        if (state.keyword) params.set("keyword", state.keyword);
        if (state.status) params.set("status", state.status);
        if (state.sort) params.set("sort", state.sort);

        return params.toString();
      }

      function badgeClass(status) {
        const s = String(status || "").toUpperCase();
        if (s === "OPEN") return "badge badge--blue";
        if (s === "CLOSED") return "badge badge--gray";
        if (s === "DELETED") return "badge badge--red";
        return "badge badge--gray";
      }

      function formatDate(value) {
        if (!value) return "-";
        const d = new Date(value);
        if (isNaN(d.getTime())) return String(value);
        const pad = (n) => String(n).padStart(2, "0");
        return d.getFullYear() + "-" + pad(d.getMonth() + 1) + "-" + pad(d.getDate());
      }

      function escapeHtml(s) {
        return String(s)
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#039;");
      }

      function renderCards(items) {
        const list = $("cardList");
        const empty = $("emptyState");
        list.innerHTML = "";

        if (!items || items.length === 0) {
          empty.style.display = "block";
          return;
        }
        empty.style.display = "none";

        items.forEach((p) => {
          const postId = p.postId ?? p.id;
          const title = p.title ?? "-";
          const status = p.postStatus ?? p.status ?? "-";
          const viewCount = p.viewCount ?? 0;
          const scrapCount = p.scrapCount ?? 0;
          const commentCount = p.commentCount ?? 0;
          const createdAt = formatDate(p.createdAt);

          const tags = Array.isArray(p.skillTags) ? p.skillTags : [];
          const tagHtml = tags.slice(0, 6).map((t) => {
            const name = (t && typeof t === "object") ? (t.name ?? t.tagName ?? "") : String(t);
            if (!name) return "";
            return `<span class="chip">${escapeHtml(name)}</span>`;
          }).join("");

          const card = document.createElement("a");
          card.className = "postcard";
          card.href = "/board/posts/" + postId;

          card.innerHTML = `
            <div class="postcard__top">
              <span class="${badgeClass(status)}">${escapeHtml(String(status).toUpperCase())}</span>
              <span class="postcard__date">${createdAt}</span>
            </div>
            <div class="postcard__title">${escapeHtml(title)}</div>
            <div class="postcard__meta">
              <span class="meta__item">ğŸ‘ <b>${viewCount}</b></span>
              <span class="meta__dot">Â·</span>
              <span class="meta__item">ğŸ”– <b>${scrapCount}</b></span>
              <span class="meta__dot">Â·</span>
              <span class="meta__item">ğŸ’¬ <b>${commentCount}</b></span>
            </div>
            <div class="postcard__tags">${tagHtml}</div>
          `;

          list.appendChild(card);
        });
      }

      function updatePager() {
        $("pageInfo").innerText = String(state.page + 1) + " / " + String(state.totalPages);
        $("prevBtn").disabled = state.page <= 0;
        $("nextBtn").disabled = state.page >= state.totalPages - 1;
      }

      function load() {
        const url = "/api/board/posts?" + buildQuery();
        return fetchJson(url)
          .then((res) => {
            const data = getApiData(res) || {};
            const content = data.content ?? data.posts ?? data.items ?? [];
            const totalPages = data.totalPages ?? data.pageInfo?.totalPages ?? 1;

            state.totalPages = Number(totalPages || 1);
            renderCards(Array.isArray(content) ? content : []);
            updatePager();
          })
          .catch(async (r) => {
            // ë¡œê·¸ì¸/ì •ì±… ìœ„ë°˜(ì˜ˆ: 401/403/409)ìœ¼ë¡œ ëª©ë¡ì´ ë§‰íŒ ê²½ìš° UIë¥¼ ë¹„ìš°ê³  ëëƒ„
            renderCards([]);
            state.totalPages = 1;
            updatePager();
            try {
              await r.text();
            } catch (e) {
            }
          });
      }

      $("applyBtn").addEventListener("click", () => {
        state.keyword = String($("keyword").value || "").trim();
        state.status = String($("status").value || "").trim();
        state.sort = String($("sort").value || "LATEST").trim();
        state.page = 0;
        load();
      });

      $("resetBtn").addEventListener("click", () => {
        $("keyword").value = "";
        $("status").value = "";
        $("sort").value = "LATEST";

        state.keyword = "";
        state.status = "";
        state.sort = "LATEST";
        state.page = 0;
        load();
      });

      $("prevBtn").addEventListener("click", () => {
        if (state.page <= 0) return;
        state.page -= 1;
        load();
      });

      $("nextBtn").addEventListener("click", () => {
        if (state.page >= state.totalPages - 1) return;
        state.page += 1;
        load();
      });

      load();
    })();
  </script>
</section>
</body>
</html>
