<!-- src/main/resources/templates/board/post-list.html -->
<!DOCTYPE html>
<html
  lang="ko"
  xmlns:th="http://www.thymeleaf.org"
  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
  layout:decorate="~{common/layout/base}"
>
<head>
  <th:block layout:fragment="head">
    <link rel="stylesheet" th:href="@{/css/board/board-post-list.css}"/>
  </th:block>
</head>

<body>
<section layout:fragment="content">
  <main class="board-page">
    <div class="board-shell">
      <header class="board-header">
        <h1 class="board-title">ê³µê°œ ê²Œì‹œíŒ</h1>
        <p class="board-subtitle">ë©˜í† ì™€ ë©˜í‹°ê°€ í•¨ê»˜ ë‹µë³€ì„ ë‚˜ëˆ„ëŠ” ì§ˆë¬¸ ê³µê°„</p>
      </header>

      <div class="board-top">
        <a class="btn-write" th:href="@{/board/posts/new}">
          <span class="btn-write__icon">+</span>
          <span>ì§ˆë¬¸ ì‘ì„±í•˜ê¸°</span>
        </a>

        <div class="board-controls">
          <div class="select-wrap">
            <label class="select-label" for="sortSelect">ì •ë ¬</label>
            <select id="sortSelect" class="select">
              <option value="LATEST" selected>ìµœì‹ ìˆœ</option>
              <option value="LIKES">ì¢‹ì•„ìš”ìˆœ</option>
              <option value="SCRAPS">ìŠ¤í¬ë©ìˆœ</option>
            </select>
          </div>

          <div class="select-wrap">
            <label class="select-label" for="statusSelect">ìƒíƒœ</label>
            <select id="statusSelect" class="select">
              <option value="" selected>ì „ì²´</option>
              <option value="OPEN">OPEN</option>
              <option value="CLOSED">CLOSED</option>
            </select>
          </div>
        </div>
      </div>

      <nav class="board-tabs" aria-label="ì¹´í…Œê³ ë¦¬ íƒ­">
        <button class="tab active" type="button" data-consulting="">
          ì „ì²´
        </button>
        <button class="tab" type="button" data-consulting="CAREER">
          ì»¤ë¦¬ì–´
        </button>
        <button class="tab" type="button" data-consulting="RESUME">
          ì´ë ¥ì„œ
        </button>
        <button class="tab" type="button" data-consulting="INTERVIEW">
          ë©´ì ‘
        </button>
        <button class="tab" type="button" data-consulting="PORTFOLIO">
          í¬íŠ¸í´ë¦¬ì˜¤
        </button>
        <button class="tab" type="button" data-consulting="TECH">
          ê¸°ìˆ 
        </button>
        <button class="tab" type="button" data-consulting="ETC">
          ê¸°íƒ€
        </button>
      </nav>

      <section class="board-grid">
        <div class="post-area">
          <div id="postGrid" class="post-grid" aria-live="polite"></div>

          <div class="paging">
            <button id="prevBtn" class="paging-btn" type="button" disabled>
              ì´ì „
            </button>
            <div id="pageNums" class="paging-nums"></div>
            <button id="nextBtn" class="paging-btn" type="button" disabled>
              ë‹¤ìŒ
            </button>
          </div>
        </div>

        <aside class="filter-card">
          <h2 class="filter-title">í•„í„°</h2>
          <div id="tagList" class="filter-list">
            <!-- ìŠ¤í‚¬íƒœê·¸ ëª©ë¡ API ì—°ë™ ì „ê¹Œì§€ëŠ” ì„ì‹œ í‘œì‹œ -->
            <label class="filter-item">
              <input type="checkbox" value="1"/>
              <span>Java</span>
            </label>
            <label class="filter-item">
              <input type="checkbox" value="2"/>
              <span>Spring</span>
            </label>
            <label class="filter-item">
              <input type="checkbox" value="3"/>
              <span>React</span>
            </label>
            <label class="filter-item">
              <input type="checkbox" value="4"/>
              <span>Python</span>
            </label>
            <label class="filter-item">
              <input type="checkbox" value="5"/>
              <span>JavaScript</span>
            </label>
          </div>

          <button id="applyFilterBtn" class="filter-apply" type="button">
            í•„í„° ì ìš©
          </button>
        </aside>
      </section>
    </div>

    <input type="hidden" id="pageSize" value="6"/>
  </main>

  <script>
    (function () {
      const postGrid = document.getElementById("postGrid");
      const sortSelect = document.getElementById("sortSelect");
      const statusSelect = document.getElementById("statusSelect");
      const applyFilterBtn = document.getElementById("applyFilterBtn");
      const tagList = document.getElementById("tagList");
      const pageNums = document.getElementById("pageNums");
      const prevBtn = document.getElementById("prevBtn");
      const nextBtn = document.getElementById("nextBtn");
      const pageSize = Number(document.getElementById("pageSize").value || 6);

      let state = {
        consultingTag: "",
        sort: "LATEST",
        status: "",
        tagIds: [],
        page: 0,
        size: pageSize,
      };

      function escapeHtml(s) {
        return String(s || "")
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#039;");
      }

      function buildQuery() {
        const p = new URLSearchParams();
        if (state.consultingTag) p.set("consultingTag", state.consultingTag);
        if (state.sort) p.set("sort", state.sort);
        if (state.status) p.set("status", state.status);
        if (state.tagIds && state.tagIds.length > 0) {
          state.tagIds.forEach((id) => p.append("tagIds", id));
        }
        p.set("page", String(state.page));
        p.set("size", String(state.size));
        return p.toString();
      }

      function statusBadge(status) {
        const s = String(status || "").toUpperCase();
        if (s === "OPEN") return '<span class="badge badge--open">OPEN</span>';
        if (s === "CLOSED") return '<span class="badge badge--closed">CLOSED</span>';
        return '<span class="badge badge--closed">-</span>';
      }

      function renderCard(item) {
        const postId = item.postId;
        const title = escapeHtml(item.title);
        const status = statusBadge(item.postStatus);
        const viewCount = item.viewCount ?? 0;
        const commentCount = item.commentCount ?? 0;
        const scrapCount = item.scrapCount ?? 0;
        const tags = Array.isArray(item.skillTags) ? item.skillTags : [];
        const tagHtml = tags
          .slice(0, 5)
          .map((t) => `<span class="chip">${escapeHtml(t)}</span>`)
          .join("");

        return `
              <a class="post-card" href="/board/posts/${postId}">
                <div class="post-card__top">
                  ${status}
                </div>
                <h3 class="post-card__title">${title}</h3>

                <div class="post-card__kpi">
                  <span class="kpi"><span class="kpi__icon">ğŸ‘</span>${viewCount}</span>
                  <span class="kpi"><span class="kpi__icon">ğŸ’¬</span>${commentCount}</span>
                  <span class="kpi"><span class="kpi__icon">ğŸ”–</span>${scrapCount}</span>
                </div>

                <div class="post-card__tags">
                  ${tagHtml}
                </div>
              </a>
            `;
      }

      function renderPaging(page, totalPages) {
        pageNums.innerHTML = "";
        const max = Math.min(totalPages, 5);
        const start = Math.max(0, Math.min(page - 2, totalPages - max));

        for (let i = 0; i < max; i++) {
          const p = start + i;
          const btn = document.createElement("button");
          btn.type = "button";
          btn.className = "paging-num" + (p === page ? " active" : "");
          btn.textContent = String(p + 1);
          btn.addEventListener("click", () => {
            state.page = p;
            load();
          });
          pageNums.appendChild(btn);
        }

        prevBtn.disabled = page <= 0;
        nextBtn.disabled = page >= totalPages - 1;
      }

      function renderEmpty() {
        postGrid.innerHTML = `
              <div class="empty">
                <div class="empty__title">ê²Œì‹œê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</div>
                <div class="empty__desc">í•„í„°ë¥¼ í•´ì œí•˜ê±°ë‚˜ ì²« ì§ˆë¬¸ì„ ì‘ì„±í•´ë³´ì„¸ìš”.</div>
              </div>
            `;
        renderPaging(0, 1);
      }

      function load() {
        postGrid.innerHTML = `
              <div class="loading">
                <div class="loading__dot"></div>
                <div class="loading__text">ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
              </div>
            `;

        const qs = buildQuery();
        fetch("/api/board/posts?" + qs, {headers: {Accept: "application/json"}})
          .then((r) => (r.ok ? r.json() : Promise.reject(r)))
          .then((res) => {
            const dto = res && res.data != null ? res.data : res;
            const content = dto && dto.content ? dto.content : [];

            if (!Array.isArray(content) || content.length === 0) {
              renderEmpty();
              return;
            }

            postGrid.innerHTML = content.map(renderCard).join("");

            const page = Number(dto.page ?? 0);
            const totalPages = Number(dto.totalPages ?? 1);
            renderPaging(page, totalPages);
          })
          .catch(() => {
            postGrid.innerHTML = `
                  <div class="empty">
                    <div class="empty__title">ëª©ë¡ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>
                    <div class="empty__desc">ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.</div>
                  </div>
                `;
            renderPaging(0, 1);
          });
      }

      document.querySelectorAll(".tab").forEach((btn) => {
        btn.addEventListener("click", () => {
          document.querySelectorAll(".tab").forEach((b) => b.classList.remove("active"));
          btn.classList.add("active");
          state.consultingTag = btn.dataset.consulting || "";
          state.page = 0;
          load();
        });
      });

      sortSelect.addEventListener("change", () => {
        state.sort = sortSelect.value || "LATEST";
        state.page = 0;
        load();
      });

      statusSelect.addEventListener("change", () => {
        state.status = statusSelect.value || "";
        state.page = 0;
        load();
      });

      applyFilterBtn.addEventListener("click", () => {
        const ids = [];
        tagList.querySelectorAll("input[type='checkbox']:checked").forEach((c) => {
          ids.push(String(c.value));
        });
        state.tagIds = ids;
        state.page = 0;
        load();
      });

      prevBtn.addEventListener("click", () => {
        if (state.page <= 0) return;
        state.page -= 1;
        load();
      });

      nextBtn.addEventListener("click", () => {
        state.page += 1;
        load();
      });

      load();
    })();
  </script>
</section>
</body>
</html>
