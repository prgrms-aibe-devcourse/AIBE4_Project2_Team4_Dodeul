<!-- src/main/resources/templates/board/post-list.html -->
<!DOCTYPE html>
<html
  lang="ko"
  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
  xmlns:th="http://www.thymeleaf.org"
  layout:decorate="~{common/layout/base}"
>
<head>
  <th:block layout:fragment="head">
    <link rel="stylesheet" th:href="@{/css/board/board-post-list.css}"/>
  </th:block>
</head>

<body>
<section layout:fragment="content">
  <main class="board-list">
    <header class="board-list__header">
      <div class="board-list__titlebox">
        <h1 class="board-list__title">공개 게시판</h1>
        <p class="board-list__desc">질문을 올리고 답변을 받아보세요.</p>
      </div>

      <div class="board-list__actions">
        <a class="btn btn--primary" th:href="@{/board/posts/new}">질문 작성</a>
      </div>
    </header>

    <!-- 상단 필터 영역 (Form 태그 제거, JS 처리) -->
    <div class="board-filters card">
      <div class="board-filters__row">
        <div class="field">
          <label class="field__label" for="keywordInput">검색</label>
          <div class="field__search">
            <input
              id="keywordInput"
              class="field__input"
              type="text"
              placeholder="제목/본문 키워드"
              th:value="${param.keyword}"
              onkeydown="if(event.key === 'Enter') { event.preventDefault(); applyFilters(); }"
            />
            <button type="button" class="btn btn--icon" aria-label="검색" onclick="applyFilters()">🔍</button>
          </div>
        </div>

        <div class="field">
          <label class="field__label" for="statusSelect">상태</label>
          <select id="statusSelect" class="field__select" onchange="applyFilters()">
            <option value="">전체</option>
            <option value="OPEN" th:selected="${param.status != null && param.status[0] == 'OPEN'}">OPEN</option>
            <option value="CLOSED" th:selected="${param.status != null && param.status[0] == 'CLOSED'}">CLOSED</option>
          </select>
        </div>

        <div class="field">
          <label class="field__label" for="sortSelect">정렬</label>
          <select id="sortSelect" class="field__select" onchange="applyFilters()">
            <option value="LATEST" th:selected="${param.sort == null || param.sort[0] == 'LATEST'}">최신순</option>
            <option value="VIEWS" th:selected="${param.sort != null && param.sort[0] == 'VIEWS'}">조회수순</option>
            <option value="SCRAPS" th:selected="${param.sort != null && param.sort[0] == 'SCRAPS'}">스크랩순</option>
          </select>
        </div>

        <a th:href="@{/board/posts}" class="btn btn--ghost">초기화</a>
      </div>

      <div class="board-filters__hint">
        검색/필터 사용 시 로그인 정책이 적용될 수 있습니다.
      </div>
    </div>

    <div class="board-body">
      <!-- 게시글 카드 그리드 -->
      <section class="board-cards">
        <!-- 빈 상태 -->
        <div th:if="${posts == null || posts.isEmpty()}" class="empty">
          <div class="empty__title">게시글이 없습니다.</div>
          <div class="empty__desc">첫 질문을 작성해보세요.</div>
        </div>

        <!-- 게시글 목록 -->
        <div th:unless="${posts == null || posts.isEmpty()}" class="board-cards__grid">
          <a
            th:each="post : ${posts}"
            th:href="@{/board/posts/{id}(id=${post.postId})}"
            class="postcard"
          >
            <div class="postcard__top">
              <span
                th:class="${post.postStatus == 'OPEN' ? 'badge badge--blue' : 'badge badge--gray'}"
                th:text="${post.postStatus}"
              ></span>
              <span class="postcard__date" th:text="${#temporals.format(post.createdAt, 'yyyy-MM-dd')}"></span>
            </div>

            <div class="postcard__title" th:text="${post.title}">제목</div>

            <div class="postcard__meta">
              <span class="meta__item">👁 <b th:text="${post.viewCount}">0</b></span>
              <span class="meta__dot">·</span>
              <span class="meta__item">📖 <b th:text="${post.scrapCount}">0</b></span>
              <span class="meta__dot">·</span>
              <span class="meta__item">💬 <b th:text="${post.commentCount}">0</b></span>
            </div>

            <div class="postcard__tags">
              <span
                th:each="tag, iterStat : ${post.skillTags}"
                th:if="${iterStat.index < 6}"
                class="chip"
                th:text="${tag}"
              ></span>
              <span
                th:if="${post.skillTags != null && post.skillTags.size() > 6}"
                class="chip chip--more"
                th:text="'+' + ${post.skillTags.size() - 6}"
              ></span>
            </div>
          </a>
        </div>
      </section>

      <!-- 사이드바 필터 -->
      <aside class="board-aside">
        <div class="card side">
          <div class="side__head">
            <h2 class="side__title">필터</h2>
          </div>

          <div class="side__section">
            <div class="side__label">기술 스택</div>
            <div class="side__hint">원하는 태그를 선택하세요</div>

            <div class="side__tagbox">
              <label
                th:each="tag : ${skillTags}"
                class="tagcheck"
              >
                <input
                  type="checkbox"
                  name="tagIds"
                  th:value="${tag.id}"
                  th:checked="${param.tagIds != null && #lists.contains(param.tagIds, tag.id.toString())}"
                  class="tagcheck__input tag-filter"
                  onchange="applyFilters()"
                />
                <span class="tagcheck__box"></span>
                <span class="tagcheck__text" th:text="${tag.name}"></span>
              </label>
            </div>
          </div>
        </div>
      </aside>
    </div>

    <!-- 페이지네이션 -->
    <nav th:if="${totalPages > 0}" class="pager" aria-label="페이지네이션">
      <a
        th:if="${currentPage > 0}"
        th:href="@{/board/posts(page=${currentPage - 1}, size=${pageSize}, keyword=${param.keyword}, status=${param.status}, sort=${param.sort}, tagIds=${param.tagIds})}"
        class="btn btn--ghost"
      >이전</a>
      <button th:unless="${currentPage > 0}" class="btn btn--ghost" disabled>이전</button>

      <div class="pager__info">
        <span th:text="${currentPage + 1} + ' / ' + ${totalPages}">1 / 1</span>
      </div>

      <a
        th:if="${currentPage < totalPages - 1}"
        th:href="@{/board/posts(page=${currentPage + 1}, size=${pageSize}, keyword=${param.keyword}, status=${param.status}, sort=${param.sort}, tagIds=${param.tagIds})}"
        class="btn btn--ghost"
      >다음</a>
      <button th:unless="${currentPage < totalPages - 1}" class="btn btn--ghost" disabled>다음</button>
    </nav>
  </main>

  <script>
    function applyFilters() {
      const keyword = document.getElementById('keywordInput').value;
      const status = document.getElementById('statusSelect').value;
      const sort = document.getElementById('sortSelect').value;

      const params = new URLSearchParams();

      if (keyword) params.append('keyword', keyword);
      if (status) params.append('status', status);
      if (sort) params.append('sort', sort);

      // 태그 체크박스 수집
      document.querySelectorAll('.tag-filter:checked').forEach(cb => {
        params.append('tagIds', cb.value);
      });

      // 페이지 이동
      window.location.href = '/board/posts?' + params.toString();
    }
  </script>
</section>
</body>
</html>
