<!-- src/main/resources/templates/board/post-form.html -->
<!doctype html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="utf-8"/>
  <meta http-equiv="x-ua-compatible" content="ie=edge"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>ì§ˆë¬¸ ì‘ì„±í•˜ê¸°</title>

  <!-- ê¸°ì¡´ common/board.cssëŠ” ìœ ì§€í•˜ë˜, ê²Œì‹œíŒ í¼ ì „ìš© CSSë¥¼ ì¶”ê°€ -->
  <link rel="stylesheet" th:href="@{/css/common.css}"/>
  <link rel="stylesheet" th:href="@{/css/board.css}"/>
  <link rel="stylesheet" th:href="@{/css/board/board-post.css}"/>
</head>

<body>
<main class="page">
  <div class="shell board-post-form-wrap">
    <div class="card board-post-form-card">
      <header class="board-post-form-header">
        <h1 class="board-post-form-title">ì§ˆë¬¸ ì‘ì„±í•˜ê¸°</h1>
        <p class="board-post-form-subtitle">ì§ˆë¬¸ì„ êµ¬ì²´ì ìœ¼ë¡œ ì‘ì„±í•˜ë©´ ë” ì¢‹ì€ ë‹µë³€ì„ ë°›ì„ ìˆ˜ ìˆì–´ìš”.</p>
      </header>

      <form
        th:action="@{/board/posts}"
        th:object="${form}"
        method="post"
        enctype="multipart/form-data">

        <!-- ì œëª© -->
        <div class="group">
          <label class="board-post-label" for="title">ì œëª©</label>
          <input
            id="title"
            type="text"
            th:field="*{title}"
            placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”"
            class="board-post-input"/>
          <div
            th:if="${#fields.hasErrors('title')}"
            th:errors="*{title}"
            class="board-post-error">
          </div>
        </div>

        <!-- ë¶„ì•¼ -->
        <div class="group">
          <label class="board-post-label" for="consultingTag">ë¶„ì•¼</label>
          <select
            id="consultingTag"
            th:field="*{consultingTag}"
            class="board-post-select">
            <option value="" disabled selected>ì„ íƒí•˜ì„¸ìš”</option>
            <option
              th:each="tag : ${consultingTags}"
              th:value="${tag}"
              th:text="${tag}">
            </option>
          </select>
          <div
            th:if="${#fields.hasErrors('consultingTag')}"
            th:errors="*{consultingTag}"
            class="board-post-error">
          </div>
        </div>

        <!-- ê¸°ìˆ  ìŠ¤íƒ -->
        <div class="group">
          <div class="row-head">
            <label class="board-post-label">ê¸°ìˆ  ìŠ¤íƒ</label>
          </div>

          <div class="board-post-tag-box">
            <div class="board-post-tag-list">
              <label th:each="tag : ${skillTags}" class="board-post-tag-item">
                <input
                  type="checkbox"
                  name="skillTagIds"
                  th:value="${tag.id}"
                  class="board-post-tag-checkbox"/>
                <span th:text="${tag.name}" class="board-post-tag-name">JAVA</span>
              </label>
            </div>
          </div>
        </div>

        <!-- íƒœê·¸ ì¶”ê°€ -->
        <div class="group">
          <label class="board-post-label" for="skillTagIdString">íƒœê·¸ ì¶”ê°€(ì‰¼í‘œë¡œ êµ¬ë¶„)</label>
          <input
            id="skillTagIdString"
            type="text"
            name="skillTagIdString"
            th:value="${skillTagIdString}"
            placeholder="ì˜ˆ: Java, Spring, Docker ë˜ëŠ” 1,2,3"
            class="board-post-input"/>
          <div class="board-post-hint">
            ì˜ˆ: Java, Spring, JPA (ë˜ëŠ” íƒœê·¸ IDë¥¼ ì‰¼í‘œë¡œ ì…ë ¥)
          </div>
        </div>

        <!-- ë³¸ë¬¸ -->
        <div class="group">
          <label class="board-post-label" for="content">ë³¸ë¬¸</label>
          <textarea
            id="content"
            th:field="*{content}"
            rows="10"
            placeholder="ì§ˆë¬¸ ë‚´ìš©ì„ ìì„¸íˆ ì‘ì„±í•´ì£¼ì„¸ìš”"
            class="board-post-textarea"></textarea>
          <div
            th:if="${#fields.hasErrors('content')}"
            th:errors="*{content}"
            class="board-post-error">
          </div>
        </div>

        <!-- ì²¨ë¶€íŒŒì¼ (ìƒì„¸ ì²¨ë¶€íŒŒì¼ UIì™€ ìœ ì‚¬í•˜ê²Œ) -->
        <div class="group">
          <label class="board-post-label">ì²¨ë¶€íŒŒì¼</label>

          <div id="uploadBox" class="board-upload">
            <input
              type="file"
              id="files"
              name="files"
              multiple
              accept=".jpg,.jpeg,.png,.gif,.pdf,.txt,.ppt,.pptx"
              class="board-upload__input"
              onchange="onFilesChanged(this)"/>

            <div class="board-upload__inner" onclick="document.getElementById('files').click()">
              <div class="board-upload__icon">ğŸ“</div>
              <div class="board-upload__text">íŒŒì¼ ì„ íƒ</div>
              <div class="board-upload__sub">ìµœëŒ€ 5ê°œ, ê° 10MB ì´í•˜ (ì´ë¯¸ì§€/PDF/TXT/PPT)</div>
            </div>

            <div id="fileList" class="board-upload__list" aria-live="polite"></div>
          </div>

          <div class="board-post-hint">
            ë“œë˜ê·¸ ì•¤ ë“œë¡­ë„ ì§€ì›í•©ë‹ˆë‹¤.
          </div>
        </div>

        <!-- ì•¡ì…˜ -->
        <div class="board-post-actions">
          <a th:href="@{/board/posts}" class="btn btn--ghost">ì·¨ì†Œ</a>
          <button type="submit" class="btn btn--primary">ë“±ë¡</button>
        </div>
      </form>
    </div>
  </div>
</main>

<script>
  // ===== ì—…ë¡œë“œ ê²€ì¦ + ë¯¸ë¦¬ë³´ê¸° ë¦¬ìŠ¤íŠ¸(ì¹©) =====
  const MAX_FILES = 5;
  const MAX_SIZE = 10 * 1024 * 1024; // 10MB
  const ALLOWED_EXT = /(\.jpg|\.jpeg|\.png|\.gif|\.pdf|\.txt|\.ppt|\.pptx)$/i;

  function formatBytes(bytes) {
    if (!bytes && bytes !== 0) return "";
    const units = ["B", "KB", "MB", "GB"];
    let b = bytes;
    let i = 0;
    while (b >= 1024 && i < units.length - 1) {
      b /= 1024;
      i += 1;
    }
    return (i === 0 ? b : b.toFixed(1)) + units[i];
  }

  function validateFiles(input) {
    const files = input.files;
    if (!files || files.length === 0) return true;

    if (files.length > MAX_FILES) {
      alert("ì²¨ë¶€íŒŒì¼ì€ ìµœëŒ€ 5ê°œê¹Œì§€ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
      input.value = "";
      return false;
    }

    for (const file of files) {
      if (file.size > MAX_SIZE) {
        alert("íŒŒì¼ í¬ê¸°ëŠ” 10MBë¥¼ ì´ˆê³¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        input.value = "";
        return false;
      }
      if (!ALLOWED_EXT.exec(file.name)) {
        alert("í—ˆìš©ë˜ì§€ ì•ŠëŠ” íŒŒì¼ í˜•ì‹ì…ë‹ˆë‹¤.\n(ì´ë¯¸ì§€, PDF, TXT, PPT íŒŒì¼ë§Œ ê°€ëŠ¥)");
        input.value = "";
        return false;
      }
    }
    return true;
  }

  function renderFileList(input) {
    const list = document.getElementById("fileList");
    list.innerHTML = "";

    const files = input.files;
    if (!files || files.length === 0) return;

    Array.from(files).forEach((f, idx) => {
      const chip = document.createElement("div");
      chip.className = "filechip";
      chip.innerHTML = `
        <div class="filechip__left">
          <div class="filechip__name">${escapeHtml(f.name)}</div>
          <div class="filechip__meta">${escapeHtml(f.type || "file")} Â· ${formatBytes(f.size)}</div>
        </div>
        <button type="button" class="filechip__remove" aria-label="íŒŒì¼ ì œê±°" data-idx="${idx}">Ã—</button>
      `;
      list.appendChild(chip);
    });

    // ì œê±° ë²„íŠ¼: DataTransferë¡œ ì¬êµ¬ì„±
    list.querySelectorAll(".filechip__remove").forEach((btn) => {
      btn.addEventListener("click", () => {
        const removeIdx = Number(btn.getAttribute("data-idx"));
        const dt = new DataTransfer();
        Array.from(input.files).forEach((f, i) => {
          if (i !== removeIdx) dt.items.add(f);
        });
        input.files = dt.files;
        renderFileList(input);
      });
    });
  }

  function escapeHtml(s) {
    return String(s)
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }

  function onFilesChanged(input) {
    if (!validateFiles(input)) return;
    renderFileList(input);
  }

  // ===== Drag & Drop =====
  (function initDnD() {
    const box = document.getElementById("uploadBox");
    const input = document.getElementById("files");
    if (!box || !input) return;

    box.addEventListener("dragover", (e) => {
      e.preventDefault();
      box.classList.add("is-dragover");
    });

    box.addEventListener("dragleave", () => {
      box.classList.remove("is-dragover");
    });

    box.addEventListener("drop", (e) => {
      e.preventDefault();
      box.classList.remove("is-dragover");

      const dropped = e.dataTransfer && e.dataTransfer.files ? Array.from(e.dataTransfer.files) : [];
      if (dropped.length === 0) return;

      const dt = new DataTransfer();
      const current = input.files ? Array.from(input.files) : [];
      const merged = current.concat(dropped);

      if (merged.length > MAX_FILES) {
        alert("ì²¨ë¶€íŒŒì¼ì€ ìµœëŒ€ 5ê°œê¹Œì§€ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
        return;
      }

      for (const f of merged) {
        if (f.size > MAX_SIZE) {
          alert("íŒŒì¼ í¬ê¸°ëŠ” 10MBë¥¼ ì´ˆê³¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
          return;
        }
        if (!ALLOWED_EXT.exec(f.name)) {
          alert("í—ˆìš©ë˜ì§€ ì•ŠëŠ” íŒŒì¼ í˜•ì‹ì…ë‹ˆë‹¤.\n(ì´ë¯¸ì§€, PDF, TXT, PPT íŒŒì¼ë§Œ ê°€ëŠ¥)");
          return;
        }
      }

      merged.forEach((f) => dt.items.add(f));
      input.files = dt.files;
      renderFileList(input);
    });
  })();
</script>
</body>
</html>
