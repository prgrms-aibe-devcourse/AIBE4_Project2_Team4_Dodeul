<!-- src/main/resources/templates/board/post-form.html -->
<!doctype html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>ì§ˆë¬¸ ì‘ì„±í•˜ê¸°</title>
  <link rel="stylesheet" href="/css/board/board-post.css"/>
</head>

<body>
<main class="page">
  <section class="shell">
    <article class="card board-post-form-wrap">
      <div class="board-post-form-card">
        <header class="board-post-form-header">
          <h1 class="board-post-form-title">ì§ˆë¬¸ ì‘ì„±í•˜ê¸°</h1>
          <p class="board-post-form-subtitle">ì§ˆë¬¸ì„ êµ¬ì²´ì ìœ¼ë¡œ ì‘ì„±í•˜ë©´ ë” ì¢‹ì€ ë‹µë³€ì„ ë°›ì„ ìˆ˜ ìˆì–´ìš”.</p>
        </header>

        <form
          id="createForm"
          th:action="@{/board/posts}"
          th:object="${form}"
          method="post"
          enctype="multipart/form-data"
          autocomplete="off"
        >
          <!-- ì œëª© -->
          <div class="group">
            <label class="board-post-label" for="title">ì œëª©</label>
            <input
              id="title"
              type="text"
              th:field="*{title}"
              placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”"
              maxlength="255"
              class="board-post-input"
            />
            <div
              th:if="${#fields.hasErrors('title')}"
              th:errors="*{title}"
              class="board-post-error"
            ></div>
          </div>

          <!-- ë¶„ì•¼ -->
          <div class="group">
            <label class="board-post-label" for="consultingTag">ë¶„ì•¼</label>
            <select
              id="consultingTag"
              th:field="*{consultingTag}"
              class="board-post-select"
            >
              <option value="">ì„ íƒí•˜ì„¸ìš”</option>
              <option
                th:each="t : ${consultingTags}"
                th:value="${t.name()}"
                th:text="${t.description}"
              ></option>
            </select>
            <div
              th:if="${#fields.hasErrors('consultingTag')}"
              th:errors="*{consultingTag}"
              class="board-post-error"
            ></div>
          </div>

          <!-- ê¸°ìˆ  ìŠ¤íƒ -->
          <div class="group">
            <div class="row-head">
              <label class="board-post-label">ê¸°ìˆ  ìŠ¤íƒ</label>
            </div>

            <div class="board-post-tag-box">
              <div class="board-post-tag-list" id="skillTagBox">
                <label th:each="tag : ${skillTags}" class="board-post-tag-item">
                  <input
                    type="checkbox"
                    name="skillTagIds"
                    class="board-post-tag-checkbox"
                    th:value="${tag.id}"
                    th:attr="data-name=${tag.name}"
                    th:checked="${form.skillTagIds != null && #lists.contains(form.skillTagIds, tag.id)}"
                  />
                  <span class="board-post-tag-name" th:text="${tag.name}"></span>
                </label>
              </div>
            </div>
          </div>

          <!-- íƒœê·¸ ì¶”ê°€ -->
          <div class="group">
            <label class="board-post-label" for="skillTagIdString">íƒœê·¸ ì¶”ê°€(ì‰¼í‘œë¡œ êµ¬ë¶„)</label>
            <input
              id="skillTagIdString"
              name="skillTagIdString"
              class="board-post-input"
              type="text"
              placeholder="ì˜ˆ: Java, Spring, Docker"
              th:value="${skillTagIdString}"
            />
            <div class="board-post-hint">
              ì˜ˆ: Java, Spring, JPA (ê¸°ì¡´ ê¸°ìˆ  ìŠ¤íƒ ì™¸ì— ì¶”ê°€ë¡œ ì…ë ¥)
            </div>
            <div id="duplicateWarning" class="board-post-error" style="display:none;">
              ì¤‘ë³µëœ íƒœê·¸ê°€ ìˆìŠµë‹ˆë‹¤: <span id="duplicateList"></span>
            </div>
          </div>

          <!-- ë³¸ë¬¸ -->
          <div class="group">
            <label class="board-post-label" for="content">ë³¸ë¬¸</label>
            <textarea
              id="content"
              th:field="*{content}"
              rows="12"
              placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”"
              class="board-post-textarea"
            ></textarea>
            <div
              th:if="${#fields.hasErrors('content')}"
              th:errors="*{content}"
              class="board-post-error"
            ></div>
          </div>

          <!-- ì²¨ë¶€íŒŒì¼ -->
          <div class="group">
            <label class="board-post-label">ì²¨ë¶€íŒŒì¼</label>

            <div id="uploadBox" class="board-upload">
              <input
                type="file"
                id="files"
                name="files"
                multiple
                accept=".jpg,.jpeg,.png,.gif,.pdf,.txt,.ppt,.pptx"
                class="board-upload__input"
              />

              <div id="uploadInner" class="board-upload__inner">
                <div class="board-upload__icon">ğŸ“</div>
                <div class="board-upload__text">íŒŒì¼ ì„ íƒ</div>
                <div class="board-upload__sub">ìµœëŒ€ 5ê°œ, ê° 10MB ì´í•˜ (ì´ë¯¸ì§€/PDF/TXT/PPT)</div>
              </div>

              <div id="fileList" class="board-upload__list" aria-live="polite"></div>
            </div>

            <div class="board-post-hint">
              ë“œë˜ê·¸ ì•¤ ë“œë¡­ì´ë‚˜ ì²¨ë¶€ íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.
            </div>
          </div>

          <!-- ì•¡ì…˜ -->
          <div class="board-post-actions">
            <button id="cancelBtn" type="button" class="btn btn--ghost">ì·¨ì†Œ</button>
            <button type="submit" class="btn btn--primary">ë“±ë¡</button>
          </div>
        </form>

      </div>
    </article>
  </section>
</main>

<script>
  // === ì·¨ì†Œ ===
  document.getElementById('cancelBtn')?.addEventListener('click', () => {
    window.location.href = '/board/posts';
  });

  // === ì¤‘ë³µ íƒœê·¸ ê²€ì¦ ===
  function checkDuplicateTags() {
    const checkedTags = Array.from(document.querySelectorAll('input[name="skillTagIds"]:checked'))
      .map(cb => String(cb.getAttribute("data-name") || "").trim().toLowerCase())
      .filter(name => name.length > 0);

    const textInput = document.getElementById("skillTagIdString").value || "";
    const textTags = textInput
      .split(",")
      .map(s => s.trim().toLowerCase())
      .filter(s => s.length > 0);

    const duplicates = textTags.filter(tag => checkedTags.includes(tag));

    const warning = document.getElementById("duplicateWarning");
    const duplicateList = document.getElementById("duplicateList");

    if (duplicates.length > 0) {
      duplicateList.textContent = duplicates.join(", ");
      warning.style.display = "block";
      return false;
    } else {
      warning.style.display = "none";
      return true;
    }
  }

  document.getElementById("skillTagIdString")?.addEventListener("input", checkDuplicateTags);
  document.querySelectorAll('input[name="skillTagIds"]').forEach(cb => {
    cb.addEventListener("change", checkDuplicateTags);
  });

  // === í¼ ì œì¶œ ì „ ìœ íš¨ì„± ê²€ì‚¬ (íŒŒì¼/íƒœê·¸ ìœ ì§€ìš©) ===
  document.getElementById("createForm")?.addEventListener("submit", (e) => {
    // 1. ì¤‘ë³µ íƒœê·¸ ê²€ì‚¬
    if (!checkDuplicateTags()) {
      e.preventDefault();
      alert("ì¤‘ë³µëœ íƒœê·¸ë¥¼ ì œê±°í•´ì£¼ì„¸ìš”.");
      return false;
    }

    // 2. í•„ìˆ˜ê°’ ê²€ì‚¬ (ì œëª©, ë¶„ì•¼, ë³¸ë¬¸)
    const title = document.getElementById("title").value.trim();
    const consultingTag = document.getElementById("consultingTag").value;
    const content = document.getElementById("content").value.trim();

    if (!title) {
      e.preventDefault();
      alert("ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
      document.getElementById("title").focus();
      return false;
    }

    if (!consultingTag) {
      e.preventDefault();
      alert("ë¶„ì•¼ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
      document.getElementById("consultingTag").focus();
      return false;
    }

    if (!content) {
      e.preventDefault();
      alert("ë³¸ë¬¸ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
      document.getElementById("content").focus();
      return false;
    }

    if (content.length < 10) {
      e.preventDefault();
      alert("ë³¸ë¬¸ì€ 10ì ì´ìƒ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤.");
      document.getElementById("content").focus();
      return false;
    }
  });

  // === íŒŒì¼ ì—…ë¡œë“œ ===
  const MAX_FILES = 5;
  const MAX_SIZE = 10 * 1024 * 1024;
  const ALLOWED_EXT = /(\.jpg|\.jpeg|\.png|\.gif|\.pdf|\.txt|\.ppt|\.pptx)$/i;

  const input = document.getElementById("files");
  const uploadBox = document.getElementById("uploadBox");
  const uploadInner = document.getElementById("uploadInner");

  // í˜„ì¬ ì„ íƒëœ íŒŒì¼ë“¤ì„ ì €ì¥í•˜ëŠ” ë°°ì—´ (DataTransfer ëŒ€ì‹  ì‚¬ìš©)
  let currentFiles = [];

  function formatBytes(bytes) {
    if (!bytes && bytes !== 0) return "";
    const units = ["B", "KB", "MB", "GB"];
    let b = bytes, i = 0;
    while (b >= 1024 && i < units.length - 1) {
      b /= 1024;
      i += 1;
    }
    return (i === 0 ? b : b.toFixed(1)) + units[i];
  }

  function escapeHtml(s) {
    return String(s)
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }

  function validateFiles(fileList) {
    if (!fileList || fileList.length === 0) return true;
    if (fileList.length > MAX_FILES) {
      alert("ì²¨ë¶€íŒŒì¼ì€ ìµœëŒ€ 5ê°œê¹Œì§€ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
      return false;
    }
    for (const file of fileList) {
      if (file.size > MAX_SIZE) {
        alert(`${file.name}ì˜ í¬ê¸°ê°€ 10MBë¥¼ ì´ˆê³¼í•©ë‹ˆë‹¤.`);
        return false;
      }
      if (!ALLOWED_EXT.exec(file.name)) {
        alert(`${file.name}ëŠ” í—ˆìš©ë˜ì§€ ì•ŠëŠ” íŒŒì¼ í˜•ì‹ì…ë‹ˆë‹¤.`);
        return false;
      }
    }
    return true;
  }

  // ì¤‘ë³µ ì œê±° (íŒŒì¼ëª… ê¸°ì¤€)
  function removeDuplicateFiles(fileList) {
    const seen = new Map();
    const result = [];

    for (const file of fileList) {
      if (!seen.has(file.name)) {
        seen.set(file.name, true);
        result.push(file);
      }
    }

    return result;
  }

  function getFileIcon(type) {
    if (type.includes('pdf')) return 'ğŸ“„';
    if (type.includes('presentation') || type.includes('powerpoint')) return 'ğŸ“Š';
    if (type.includes('image')) return 'ğŸ–¼ï¸';
    if (type.includes('text')) return 'ğŸ“';
    return 'ğŸ“';
  }

  function getFileTypeClass(type) {
    if (type.includes('pdf')) return 'type-pdf';
    if (type.includes('presentation') || type.includes('powerpoint')) return 'type-ppt';
    if (type.includes('image')) return 'type-image';
    if (type.includes('text')) return 'type-text';
    return '';
  }

  function renderFileList() {
    const list = document.getElementById("fileList");
    if (!list) return;

    list.innerHTML = "";
    if (currentFiles.length === 0) return;

    currentFiles.forEach((f, idx) => {
      const chip = document.createElement("div");
      const typeClass = getFileTypeClass(f.type);
      const icon = getFileIcon(f.type);

      chip.className = `filechip ${typeClass}`;
      chip.innerHTML = `
        <div class="filechip__left">
          <div class="filechip__icon">${icon}</div>
          <div class="filechip__info">
            <div class="filechip__name">${escapeHtml(f.name)}</div>
            <div class="filechip__meta">${formatBytes(f.size)}</div>
          </div>
        </div>
        <button type="button" class="filechip__remove" aria-label="íŒŒì¼ ì œê±°" data-idx="${idx}">Ã—</button>
      `;
      list.appendChild(chip);
    });

    list.querySelectorAll(".filechip__remove").forEach((btn) => {
      btn.addEventListener("click", () => {
        const removeIdx = Number(btn.getAttribute("data-idx"));
        currentFiles.splice(removeIdx, 1);
        updateInputFiles();
        renderFileList();
      });
    });
  }

  function updateInputFiles() {
    if (!input) return;
    const dt = new DataTransfer();
    currentFiles.forEach((f) => dt.items.add(f));
    input.files = dt.files;
  }

  function addFiles(newFiles) {
    // ê¸°ì¡´ íŒŒì¼ + ìƒˆ íŒŒì¼ ë³‘í•©
    const merged = currentFiles.concat(newFiles);

    // ì¤‘ë³µ ì œê±°
    const uniqueFiles = removeDuplicateFiles(merged);

    // ìœ íš¨ì„± ê²€ì‚¬
    if (!validateFiles(uniqueFiles)) {
      // ì‹¤íŒ¨ ì‹œ input ì´ˆê¸°í™” (ê¸°ì¡´ íŒŒì¼ ìœ ì§€)
      updateInputFiles();
      return;
    }

    currentFiles = uniqueFiles;
    updateInputFiles();
    renderFileList();
  }

  // í´ë¦­ìœ¼ë¡œ íŒŒì¼ ì„ íƒ
  uploadInner?.addEventListener("click", () => input?.click());

  input?.addEventListener("change", () => {
    const newFiles = input.files ? Array.from(input.files) : [];
    if (newFiles.length === 0) return;

    addFiles(newFiles);
  });

  // Drag & Drop
  if (uploadBox && input) {
    uploadBox.addEventListener("dragover", (e) => {
      e.preventDefault();
      uploadBox.classList.add("is-dragover");
    });

    uploadBox.addEventListener("dragleave", () => {
      uploadBox.classList.remove("is-dragover");
    });

    uploadBox.addEventListener("drop", (e) => {
      e.preventDefault();
      uploadBox.classList.remove("is-dragover");

      const dropped = e.dataTransfer && e.dataTransfer.files ? Array.from(e.dataTransfer.files) : [];
      if (dropped.length === 0) return;

      addFiles(dropped);
    });
  }
</script>
</body>
</html>
