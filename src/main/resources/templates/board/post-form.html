<!-- src/main/resources/templates/board/post-form.html -->
<!doctype html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>ì§ˆë¬¸ ì‘ì„±í•˜ê¸°</title>
  <link rel="stylesheet" href="/css/board/board-post.css"/>
</head>

<body>
<main class="page">
  <section class="shell">
    <article class="card board-post-form-wrap">
      <div class="board-post-form-card">
        <header class="board-post-form-header">
          <h1 class="board-post-form-title">ì§ˆë¬¸ ì‘ì„±í•˜ê¸°</h1>
          <p class="board-post-form-subtitle">ì§ˆë¬¸ì„ êµ¬ì²´ì ìœ¼ë¡œ ì‘ì„±í•˜ë©´ ë” ì¢‹ì€ ë‹µë³€ì„ ë°›ì„ ìˆ˜ ìˆì–´ìš”.</p>
        </header>

        <form
          id="createForm"
          th:action="@{/board/posts}"
          th:object="${form}"
          method="post"
          enctype="multipart/form-data"
          autocomplete="off"
        >
          <!-- ì œëª© -->
          <div class="group">
            <label class="board-post-label" for="title">ì œëª©</label>
            <input
              id="title"
              type="text"
              th:field="*{title}"
              placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”"
              maxlength="255"
              class="board-post-input"
            />
            <div
              th:if="${#fields.hasErrors('title')}"
              th:errors="*{title}"
              class="board-post-error"
            ></div>
          </div>

          <!-- ë¶„ì•¼ (ìˆ˜ì •í•˜ê¸° í¼ê³¼ ë™ì¼: value=name(), text=description) -->
          <div class="group">
            <label class="board-post-label" for="consultingTag">ë¶„ì•¼</label>
            <select
              id="consultingTag"
              th:field="*{consultingTag}"
              class="board-post-select"
            >
              <option value="">ì„ íƒí•˜ì„¸ìš”</option>
              <option
                th:each="t : ${consultingTags}"
                th:value="${t.name()}"
                th:text="${t.description}"
              ></option>
            </select>
            <div
              th:if="${#fields.hasErrors('consultingTag')}"
              th:errors="*{consultingTag}"
              class="board-post-error"
            ></div>
          </div>

          <!-- ê¸°ìˆ  ìŠ¤íƒ -->
          <div class="group">
            <div class="row-head">
              <label class="board-post-label">ê¸°ìˆ  ìŠ¤íƒ</label>
            </div>

            <div class="board-post-tag-box">
              <div class="board-post-tag-list" id="skillTagBox">
                <label th:each="tag : ${skillTags}" class="board-post-tag-item">
                  <input
                    type="checkbox"
                    name="skillTagIds"
                    class="board-post-tag-checkbox"
                    th:value="${tag.id}"
                    th:attr="data-name=${tag.name}"
                  />
                  <span class="board-post-tag-name" th:text="${tag.name}"></span>
                </label>
              </div>
            </div>
          </div>

          <!-- íƒœê·¸ ì¶”ê°€ -->
          <div class="group">
            <label class="board-post-label" for="skillTagIdString">íƒœê·¸ ì¶”ê°€(ì‰¼í‘œë¡œ êµ¬ë¶„)</label>
            <input
              id="skillTagIdString"
              name="skillTagIdString"
              class="board-post-input"
              type="text"
              placeholder="ì˜ˆ: Java, Spring, Docker"
              th:value="${skillTagIdString}"
            />
            <div class="board-post-hint">
              ì˜ˆ: Java, Spring, JPA (ê¸°ì¡´ ê¸°ìˆ  ìŠ¤íƒ ì™¸ì— ì¶”ê°€ë¡œ ì…ë ¥)
            </div>
          </div>

          <!-- ë³¸ë¬¸ -->
          <div class="group">
            <label class="board-post-label" for="content">ë³¸ë¬¸</label>
            <textarea
              id="content"
              th:field="*{content}"
              rows="12"
              placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”"
              class="board-post-textarea"
            ></textarea>
            <div
              th:if="${#fields.hasErrors('content')}"
              th:errors="*{content}"
              class="board-post-error"
            ></div>
          </div>

          <!-- ì²¨ë¶€íŒŒì¼ -->
          <div class="group">
            <label class="board-post-label">ì²¨ë¶€íŒŒì¼</label>

            <div id="uploadBox" class="board-upload">
              <input
                type="file"
                id="files"
                name="files"
                multiple
                accept=".jpg,.jpeg,.png,.gif,.pdf,.txt,.ppt,.pptx"
                class="board-upload__input"
              />

              <div id="uploadInner" class="board-upload__inner">
                <div class="board-upload__icon">ğŸ“</div>
                <div class="board-upload__text">íŒŒì¼ ì„ íƒ</div>
                <div class="board-upload__sub">ìµœëŒ€ 5ê°œ, ê° 10MB ì´í•˜ (ì´ë¯¸ì§€/PDF/TXT/PPT)</div>
              </div>

              <div id="fileList" class="board-upload__list" aria-live="polite"></div>
            </div>

            <div class="board-post-hint">
              ë“œë˜ê·¸ ì•¤ ë“œë¡­ì´ë‚˜ ì²¨ë¶€ íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.
            </div>
          </div>

          <!-- ì•¡ì…˜ (ìˆ˜ì •í•˜ê¸° í¼ í†¤ê³¼ ë™ì¼: ë²„íŠ¼ 2ê°œ) -->
          <div class="board-post-actions">
            <button id="cancelBtn" type="button" class="btn btn--ghost">ì·¨ì†Œ</button>
            <button type="submit" class="btn btn--primary">ë“±ë¡</button>
          </div>
        </form>

      </div>
    </article>
  </section>
</main>

<script>
  // ===== ì·¨ì†Œ =====
  document.getElementById("cancelBtn")?.addEventListener("click", () => {
    window.location.href = "/board/posts";
  });

  // ===== ì—…ë¡œë“œ ê²€ì¦ + ë¦¬ìŠ¤íŠ¸(ì¹©) =====
  const MAX_FILES = 5;
  const MAX_SIZE = 10 * 1024 * 1024; // 10MB
  const ALLOWED_EXT = /(\.jpg|\.jpeg|\.png|\.gif|\.pdf|\.txt|\.ppt|\.pptx)$/i;

  const input = document.getElementById("files");
  const uploadBox = document.getElementById("uploadBox");
  const uploadInner = document.getElementById("uploadInner");

  function formatBytes(bytes) {
    if (!bytes && bytes !== 0) return "";
    const units = ["B", "KB", "MB", "GB"];
    let b = bytes;
    let i = 0;
    while (b >= 1024 && i < units.length - 1) {
      b /= 1024;
      i += 1;
    }
    return (i === 0 ? b : b.toFixed(1)) + units[i];
  }

  function escapeHtml(s) {
    return String(s)
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }

  function validateFiles(fileList) {
    if (!fileList || fileList.length === 0) return true;

    if (fileList.length > MAX_FILES) {
      alert("ì²¨ë¶€íŒŒì¼ì€ ìµœëŒ€ 5ê°œê¹Œì§€ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
      return false;
    }

    for (const file of fileList) {
      if (file.size > MAX_SIZE) {
        alert("íŒŒì¼ í¬ê¸°ëŠ” 10MBë¥¼ ì´ˆê³¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        return false;
      }
      if (!ALLOWED_EXT.exec(file.name)) {
        alert("í—ˆìš©ë˜ì§€ ì•ŠëŠ” íŒŒì¼ í˜•ì‹ì…ë‹ˆë‹¤.\n(ì´ë¯¸ì§€, PDF, TXT, PPT íŒŒì¼ë§Œ ê°€ëŠ¥)");
        return false;
      }
    }
    return true;
  }

  function renderFileList() {
    const list = document.getElementById("fileList");
    if (!list || !input) return;

    list.innerHTML = "";
    const files = input.files ? Array.from(input.files) : [];
    if (files.length === 0) return;

    files.forEach((f, idx) => {
      const chip = document.createElement("div");
      chip.className = "filechip";
      chip.innerHTML = `
        <div class="filechip__left">
          <div class="filechip__name">${escapeHtml(f.name)}</div>
          <div class="filechip__meta">${escapeHtml(f.type || "file")} Â· ${formatBytes(f.size)}</div>
        </div>
        <button type="button" class="filechip__remove" aria-label="íŒŒì¼ ì œê±°" data-idx="${idx}">Ã—</button>
      `;
      list.appendChild(chip);
    });

    list.querySelectorAll(".filechip__remove").forEach((btn) => {
      btn.addEventListener("click", () => {
        const removeIdx = Number(btn.getAttribute("data-idx"));
        const dt = new DataTransfer();
        Array.from(input.files).forEach((f, i) => {
          if (i !== removeIdx) dt.items.add(f);
        });
        input.files = dt.files;
        renderFileList();
      });
    });
  }

  function setFiles(files) {
    if (!input) return;

    const list = Array.from(files || []);
    if (!validateFiles(list)) return;

    const dt = new DataTransfer();
    list.forEach((f) => dt.items.add(f));
    input.files = dt.files;
    renderFileList();
  }

  // í´ë¦­ìœ¼ë¡œ íŒŒì¼ ì„ íƒ
  uploadInner?.addEventListener("click", () => input?.click());
  input?.addEventListener("change", () => {
    const files = input.files ? Array.from(input.files) : [];
    if (!validateFiles(files)) {
      input.value = "";
      renderFileList();
      return;
    }
    renderFileList();
  });

  // Drag & Drop
  if (uploadBox && input) {
    uploadBox.addEventListener("dragover", (e) => {
      e.preventDefault();
      uploadBox.classList.add("is-dragover");
    });

    uploadBox.addEventListener("dragleave", () => {
      uploadBox.classList.remove("is-dragover");
    });

    uploadBox.addEventListener("drop", (e) => {
      e.preventDefault();
      uploadBox.classList.remove("is-dragover");

      const dropped = e.dataTransfer && e.dataTransfer.files ? Array.from(e.dataTransfer.files) : [];
      if (dropped.length === 0) return;

      const current = input.files ? Array.from(input.files) : [];
      const merged = current.concat(dropped);
      if (!validateFiles(merged)) return;

      setFiles(merged);
    });
  }
</script>
</body>
</html>
