<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{common/layout/mentor}">

<head>
  <th:block layout:fragment="head">
    <title>DODEUL | 상담 신청 상세</title>
    <link rel="stylesheet" href="/css/mypage/dashboard.css">
    <style>
      .detail-title { font-size: 1.25rem; font-weight: 700; margin-bottom: 8px; }
      .detail-section-title { font-weight: 700; margin-bottom: 10px; }
      .detail-content { white-space: pre-line; }
      .tag-dark {
        display: inline-block;
        background: #334155;
        color: #fff;
        padding: 0.4rem 1rem;
        border-radius: 999px;
        font-size: 0.85rem;
        margin-right: 0.5rem;
        margin-bottom: 0.5rem;
      }
      .profile-chip {
        width: 44px; height: 44px;
        border-radius: 50%;
        background: #adb5bd;
        display: flex; align-items: center; justify-content: center;
        color: #fff; font-weight: 700;
        flex: 0 0 44px;
      }
      .stack { display:flex; flex-wrap:wrap; gap:8px; }
      .divider { border-top: 1px solid var(--color-border); margin: 24px 0; }
    </style>
  </th:block>
</head>

<body>
<div layout:fragment="page">

  <div class="dashboard-header">
    <h2 class="fw-bold" style="margin-bottom:8px;">상담 신청 상세</h2>
    <p class="text-small" style="margin-bottom:16px;">신청서 내용을 확인하고 수락/거절을 처리할 수 있습니다.</p>
  </div>

  <div class="layout" style="gap:24px;">
    <!-- 좌측 카드 -->
    <aside class="sidebar" style="width: 320px;">
      <div class="sidebar-title">멘티 정보</div>

      <div style="display:flex; gap:12px; align-items:center; margin-bottom:16px;">
        <div class="profile-chip">
          <span th:text="${#strings.substring(appDetail.menteeName, 0, 1)}">김</span>
        </div>

        <div>
          <div class="fw-bold" th:text="${appDetail.menteeName}">김멘티</div>
          <div class="text-small">취업 준비생 / 백엔드 지망</div>
        </div>
      </div>

      <div style="border-top:1px solid var(--color-border); padding-top:12px; display:flex; justify-content:space-between; align-items:center;">
        <span class="text-small">현재 상태</span>

        <!-- 상태를 matchingStatus로 렌더링 -->
        <span th:switch="${matchingStatus}">
          <span th:case="'WAITING'" class="status-badge status-pending">대기중</span>
          <span th:case="'MATCHED'" class="status-badge status-approved">승인됨</span>
          <span th:case="'REJECTED'" class="status-badge status-rejected">거절됨</span>
          <span th:case="'CANCELED'" class="status-badge status-canceled">취소함</span>
          <span th:case="'TIMEOUT'" class="status-badge status-timeout">자동 취소</span>
          <span th:case="'INREVIEW'" class="status-badge status-review">리뷰 대기</span>
          <span th:case="'COMPLETED'" class="status-badge status-completed">완료</span>
          <span th:case="*" class="status-badge status-canceled">-</span>
        </span>
      </div>
    </aside>

    <!-- 우측 본문 -->
    <section class="content" style="padding: 0; border: none; box-shadow:none; background:transparent;">
      <div class="card-custom">

        <div style="margin-bottom:16px;">
          <div class="detail-section-title">기본 정보</div>
          <div class="stack">
            <span th:each="tag : ${appDetail.skillTags}"
                  class="tag-dark"
                  th:text="${tag}">Java</span>
          </div>
        </div>

        <div style="margin-bottom:16px;">
          <div class="detail-title" th:text="${appDetail.title}">
            JPA N+1 문제 해결 조언을 구하고 싶습니다.
          </div>
        </div>

        <div style="margin-bottom:16px;">
          <div class="fw-bold" style="margin-bottom:8px;">내용</div>
          <div class="text-small detail-content" th:text="${appDetail.content}">
            내용이 들어갑니다...
          </div>
        </div>

        <div style="margin-bottom:16px;" th:if="${appDetail.fileUrl != null}">
          <div class="fw-bold" style="margin-bottom:8px;">첨부 파일 및 링크</div>
          <a class="text-small" th:href="${appDetail.fileUrl}" download>
            첨부파일 다운로드
          </a>
        </div>

        <div class="divider"></div>

        <!-- WAITING(대기중)일 때만 버튼 노출 -->
        <div style="display:flex; justify-content:flex-end; gap:12px;"
             th:if="${matchingStatus == 'WAITING'}">
          <button type="button" id="btnReject" class="btn-outline-custom">
            거절하기
          </button>
          <button type="button" id="btnAccept" class="btn-primary-custom">
            수락하기
          </button>
        </div>

      </div>
    </section>
  </div>

</div>

<th:block layout:fragment="script">
  <script th:inline="javascript">
    const matchingId = [[${matchingId}]];
    const matchingStatus = [[${matchingStatus}]]; // 문자열 (WAITING, MATCHED...)

    async function apiRequest(url, options = {}) {
      const res = await fetch(url, {
        credentials: 'same-origin',
        headers: {'accept': 'application/json', ...(options.headers || {})},
        ...options
      });

      const json = await res.json().catch(() => null);
      const code = json?.code ?? res.status;
      const message = json?.message ?? `요청 실패(${res.status})`;

      if (!res.ok || (typeof code === 'number' && code >= 400)) {
        throw new Error(message);
      }

      return json;
    }

    document.getElementById('btnReject')?.addEventListener('click', async () => {
      const ok = await showConfirmModal('정말 거절하시겠습니까?');
      if (!ok) return;

      try {
        await apiRequest(`/api/matchings/${matchingId}/rejection`, { method: 'POST' });
        showCommonModal('거절 처리되었습니다.');
        setTimeout(() => location.href = '/mentor/sessions', 300);
      } catch (e) {
        showCommonModal(e?.message ?? '거절 처리에 실패했습니다.');
      }
    });

    document.getElementById('btnAccept')?.addEventListener('click', async () => {
      const ok = await showConfirmModal('이 상담을 수락할까요?');
      if (!ok) return;

      try {
        await apiRequest(`/api/matchings/${matchingId}/acceptance`, { method: 'POST' });
        showCommonModal('수락 처리되었습니다.');
        setTimeout(() => location.href = '/mentor/sessions', 300);
      } catch (e) {
        showCommonModal(e?.message ?? '수락 처리에 실패했습니다.');
      }
    });
  </script>
</th:block>

</body>
</html>
