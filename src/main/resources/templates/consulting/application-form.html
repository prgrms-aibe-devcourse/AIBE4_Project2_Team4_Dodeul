<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{common/layout/base}">

<head>
  <meta name="_csrf" th:content="${_csrf.token}"/>
  <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
  <title>ìƒë‹´ ì‹ ì²­ì„œ ì‘ì„±</title>
  <style>
    .step-circle {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 14px;
    }

    .step-active {
      background-color: #6c757d;
      color: white;
    }

    .step-inactive {
      background-color: #f8f9fa;
      color: #adb5bd;
      border: 1px solid #dee2e6;
    }

    .btn-check:checked + .btn-outline-secondary {
      background-color: #6c757d;
      color: white;
      border-color: #6c757d;
    }

    /* AI ê²°ê³¼ì°½ ìŠ¤íƒ€ì¼ */
    #aiResult {
      background-color: #f8f9fa;
      resize: none;
      border: 1px solid #dee2e6;
    }
  </style>
</head>

<body>
<section layout:fragment="content">
  <div class="container py-5" style="max-width: 800px;">

    <div class="d-flex justify-content-between mb-5 px-5">
      <div class="text-center">
        <div class="step-circle step-active mx-auto mb-2">1</div>
        <small class="fw-bold">ì‹ ì²­ì„œ ì‘ì„±</small>
      </div>
      <div class="text-center opacity-50">
        <div class="step-circle step-inactive mx-auto mb-2">2</div>
        <small>ë°©ì‹ ì„ íƒ</small>
      </div>
      <div class="text-center opacity-50">
        <div class="step-circle step-inactive mx-auto mb-2">3</div>
        <small>ë©˜í† &ì‹œê°„ ì˜ˆì•½</small>
      </div>
      <div class="text-center opacity-50">
        <div class="step-circle step-inactive mx-auto mb-2">4</div>
        <small>ìƒíƒœ í™•ì¸</small>
      </div>
    </div>

    <form th:action="${formActionUrl}" th:object="${request}" method="post">

      <div class="mb-5">
        <h4 class="fw-bold mb-2">ì¹´í…Œê³ ë¦¬ ì„ íƒ</h4>
        <p class="text-muted small mb-3">ê´€ì‹¬ ìˆëŠ” ë©˜í† ë§ ë¶„ì•¼ë¥¼ 1ê°œ ì„ íƒí•´ì£¼ì„¸ìš”.</p>
        <div class="d-flex flex-wrap gap-2">
          <th:block th:each="tag : ${consultingTags}">
            <input type="radio" class="btn-check"
                   th:field="*{consultingTag}"
                   th:value="${tag}"
                   th:id="${'tag-' + tag.name()}" autocomplete="off" required>
            <label class="btn btn-outline-secondary"
                   th:for="${'tag-' + tag.name()}"
                   th:text="${tag.description}">ì¹´í…Œê³ ë¦¬ëª…</label>
          </th:block>
        </div>
      </div>

      <div class="card bg-light border-0 mb-4">
        <div class="card-body p-4">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h5 class="fw-bold m-0">ğŸ¤– AI ë¹„ì„œì™€ í•¨ê»˜ ì‘ì„±í•˜ê¸°</h5>
            <span class="badge bg-primary">Beta</span>
          </div>
          <p class="text-muted small">í‚¤ì›Œë“œë§Œ ì…ë ¥í•˜ë©´ AIê°€ ì •ì¤‘í•œ ìƒë‹´ ì‹ ì²­ì„œë¥¼ ëŒ€ì‹  ì¨ë“œë¦½ë‹ˆë‹¤.</p>

          <button type="button" class="btn btn-white border w-100 py-2 text-primary fw-bold bg-white"
                  data-bs-toggle="modal" data-bs-target="#aiModal">
            âœ¨ ëˆŒëŸ¬ì„œ AI ì´ˆì•ˆ ìƒì„± ë„ìš°ë¯¸ ì—´ê¸°
          </button>
        </div>
      </div>

      <div class="mb-4">
        <label class="fw-bold mb-2">ìƒë‹´ ì œëª©</label>
        <input type="text" class="form-control p-3" th:field="*{title}"
               placeholder="ë©˜í† ë§ ìƒë‹´ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”" required>
      </div>

      <div class="mb-4">
        <label class="fw-bold mb-2">ìƒë‹´ ë‚´ìš©</label>
        <textarea id="content" class="form-control p-3" th:field="*{content}" rows="6"
                  placeholder="ìƒë‹´ ë°›ê³  ì‹¶ì€ ë‚´ìš©ê³¼ ëª©í‘œë¥¼ ìƒì„¸í•˜ê²Œ ì‘ì„±í•´ì£¼ì„¸ìš”."
                  required oninput="updateCharCount(this)"></textarea>
        <div id="charCount" class="text-end text-muted small mt-1">0/1000</div>
      </div>

      <div class="mb-4">
        <label class="fw-bold mb-2">ìŠ¤í‚¬ íƒœê·¸</label>
        <input type="text" class="form-control p-3" th:field="*{techTags}"
               placeholder="ì˜ˆ: Java, React, PM (ì‰¼í‘œë¡œ êµ¬ë¶„)">
      </div>

      <div class="mb-5">
        <label class="fw-bold mb-2">ì²¨ë¶€íŒŒì¼</label>
        <input type="text" class="form-control" th:field="*{fileUrl}"
               placeholder="íŒŒì¼ URLì„ ì…ë ¥í•˜ì„¸ìš”">
      </div>

      <hr class="my-5">

      <div class="d-flex justify-content-between">
        <button type="button" class="btn btn-outline-secondary px-4 py-2" onclick="history.back()">
          < ì´ì „ ë‹¨ê³„
        </button>
        <button type="submit" class="btn btn-dark px-4 py-2">
          ë‹¤ìŒ ë‹¨ê³„ >
        </button>
      </div>
    </form>
  </div>

  <div class="modal fade" id="aiModal" tabindex="-1" aria-labelledby="aiModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title fw-bold" id="aiModalLabel">ğŸ¤– AI ì´ˆì•ˆ ìƒì„± ê²°ê³¼</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="aiKeywords" class="form-label fw-bold">ì–´ë–¤ ê³ ë¯¼ì´ ìˆìœ¼ì‹ ê°€ìš”?</label>
            <input type="text" class="form-control" id="aiKeywords"
                   placeholder="ì˜ˆ: ìŠ¤í”„ë§ ë¶€íŠ¸ ì—ëŸ¬, ì·¨ì—… í¬íŠ¸í´ë¦¬ì˜¤ ê³ ë¯¼, ìì†Œì„œ ì²¨ì‚­">
          </div>

          <div class="mb-3">
            <label for="aiResult" class="form-label fw-bold">ì¶”ì²œ ë³¸ë¬¸</label>
            <textarea class="form-control" id="aiResult" rows="8"
                      placeholder="í‚¤ì›Œë“œë¥¼ ì…ë ¥í•˜ê³  ìƒì„± ë²„íŠ¼ì„ ëˆ„ë¥´ë©´, ì—¬ê¸°ì— AIê°€ ì“´ ê¸€ì´ ë‚˜ì˜µë‹ˆë‹¤."></textarea>
          </div>
        </div>
        <div class="modal-footer justify-content-between">
          <button type="button" class="btn btn-primary" id="generateBtn" onclick="generateDraft()">
            âœ¨ ì´ˆì•ˆ ìƒì„±í•˜ê¸°
          </button>

          <div class="d-flex gap-2">
            <button type="button" class="btn btn-outline-secondary" onclick="generateDraft()">
              ğŸ”„ ë‹¤ì‹œ ìƒì„±í•˜ê¸°
            </button>
            <button type="button" class="btn btn-success" onclick="applyDraft()">
              âœ… ë³¸ë¬¸ì— ì ìš©í•˜ê¸°
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script th:inline="javascript">

    /* [ì¶”ê°€] ì„œë²„ì—ì„œ ë³´ë‚¸ ì—ëŸ¬ ë©”ì‹œì§€ê°€ ìˆìœ¼ë©´ ê²½ê³ ì°½ ë„ìš°ê¸° */
    /*<![CDATA[*/
    const errorMessage = [[${errorMessage}]];
    if (errorMessage) {
      alert(errorMessage);
    }
    /*]]>*/

    // ê¸€ììˆ˜ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
    function updateCharCount(textarea) {
      const currentLength = textarea.value.length;
      document.getElementById('charCount').textContent = currentLength + '/1000';
    }

    // 1. AI ìƒì„± ìš”ì²­
    async function generateDraft() {
      const keywords = document.getElementById('aiKeywords').value;
      const resultArea = document.getElementById('aiResult');
      const generateBtn = document.getElementById('generateBtn');

      if (!keywords.trim()) {
        alert("í‚¤ì›Œë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!");
        return;
      }

      // ë¡œë”© UI ì²˜ë¦¬
      const originalBtnText = generateBtn.innerText;
      generateBtn.disabled = true;
      generateBtn.innerText = "ìƒì„± ì¤‘... (ì•½ 3ì´ˆ)";
      resultArea.value = "AIê°€ ë©˜í† ë‹˜ê»˜ ë³´ë‚¼ í¸ì§€ë¥¼ ì‘ì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤... âœï¸";

      try {
        // CSRF í† í° ì²˜ë¦¬
        const csrfTokenMeta = document.querySelector('meta[name="_csrf"]');
        const csrfHeaderMeta = document.querySelector('meta[name="_csrf_header"]');
        const headers = {'Content-Type': 'application/json'};

        if (csrfTokenMeta && csrfHeaderMeta) {
          headers[csrfHeaderMeta.content] = csrfTokenMeta.content;
        }

        // API í˜¸ì¶œ
        const response = await fetch('/api/ai/draft', {
          method: 'POST',
          headers: headers,
          body: JSON.stringify({keywords: keywords})
        });

        if (!response.ok) throw new Error("ì„œë²„ í†µì‹  ì‹¤íŒ¨");

        const data = await response.json();
        resultArea.value = data.content; // ê²°ê³¼ì°½ì— í‘œì‹œ

      } catch (error) {
        console.error(error);
        resultArea.value = "ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.";
      } finally {
        generateBtn.disabled = false;
        generateBtn.innerText = originalBtnText;
      }
    }

    // 2. ë³¸ë¬¸ì— ì ìš©í•˜ê¸°
    function applyDraft() {
      const aiText = document.getElementById('aiResult').value;
      const mainContent = document.getElementById('content');

      if (!aiText || aiText.includes("ì‘ì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤")) {
        alert("ì ìš©í•  ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ì´ˆì•ˆì„ ìƒì„±í•´ì£¼ì„¸ìš”.");
        return;
      }

      // ë³¸ë¬¸ì— AI ê¸€ ì‚½ì…
      mainContent.value = aiText;

      // ê¸€ììˆ˜ ì—…ë°ì´íŠ¸
      updateCharCount(mainContent);

      // ëª¨ë‹¬ ë‹«ê¸°
      const modalEl = document.getElementById('aiModal');
      const modal = bootstrap.Modal.getInstance(modalEl);
      modal.hide();
    }
  </script>

</section>
</body>
</html>

